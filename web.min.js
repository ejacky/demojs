!function (e, t, n, r, o, i, s) {
    e.GoogleAnalyticsObject = o, e[o] = e[o] || function () {
        (e[o].q = e[o].q || []).push(arguments)
    }, e[o].l = 1 * new Date, i = t.createElement(n), s = t.getElementsByTagName(n)[0], i.async = 1, i.src = r, s.parentNode.insertBefore(i, s)
}(window, document, "script", "//www.google-analytics.com/analytics.js", "ga"), ga("create", "UA-56664276-1", "auto"), function (e) {
    "use strict";
    e.module("pubu", ["avoscloud", "pubu.controllers", "pubu.services", "pubu.directives", "pubu.filters"]).config(["avoscloudProvider", function (e) {
        e.config({"X-AVOSCloud-Application-Id": "jc1vm1lwvq4npmpxptuygcx7gcvh74s9o2nsy0d0a6m80q5b", "X-AVOSCloud-Application-Key": "r5dq9n8b993m49od3nlwuznsi4iox9uj0qzxwmcu8kz4m6r0"})
    }]).run(["$rootScope", "$location", "$http", "Qiniu", function (e, t, n, r) {
        n.defaults.headers.common.Authorization = config.token, e.$login = config.login, e.$location = t, r.define("avatar", {type: "iv2", mode: 1, w: 64, h: 64, bucket: "facecdn"}), r.define("bigavatar", {type: "iv2", mode: 1, w: 120, h: 120, bucket: "facecdn"})
    }]), e.module("pubu.controllers", []).directive("autofillFix", function () {
        return function (e, t, n) {
            t.prop("method", "POST"), n.ngSubmit && setTimeout(function () {
                t.unbind("submit").submit(function (r) {
                    r.preventDefault(), t.find("input, textarea, select").trigger("input").trigger("change").trigger("keydown"), e.$apply(n.ngSubmit)
                })
            }, 0)
        }
    }).controller("AppCtrl", ["$scope", "$timeout", function (e, t) {
        e.toast = null, e.handleResourceError = function (t) {
            var n = "Something is wrong, please try again later!";
            t.data && t.data.message && "string" == typeof t.data.message && (n = t.data.message), e.handleGlobalError(n)
        }, e.handleError = function (t) {
            e.handleGlobalError(t.message)
        }, e.handleGlobalError = function (t) {
            e.showToast({msg: t, type: "error"})
        };
        var n;
        e.showToast = function (r, o) {
            e.toast = r, n && t.cancel(n), n = t(function () {
                e.hideToast(), n = null
            }, void 0 === o ? 5e3 : o)
        }, e.hideToast = function () {
            e.toast = null
        }
    }]).controller("HomeCtrl", ["$scope", "avoscloud", function (e, t) {
        e.invite = {}, e.isInviting = !1, e.doStartInvite = function () {
            e.isInviting = !0, t.classes.get({className: "Invite", where: {email: e.invite.email}}, function (n) {
                if (n.results.length > 0)return e.invited = !0, void(e.isInviting = !1);
                var r = new t.classes;
                r.email = e.invite.email, r.$save({className: "Invite"}, function () {
                    e.invited = !0, e.isInviting = !1
                }, function () {
                    e.isInviting = !1, e.handleGlobalError("很奇怪，申请失败了，请稍后再试")
                })
            }, function () {
                e.handleGlobalError("很奇怪，申请失败了，请稍后再试"), e.isInviting = !1
            })
        }, $(window).scroll(function () {
            var e = $(".content-header"), t = $(window).scrollTop();
            t >= 250 ? e.addClass("dark") : e.removeClass("dark")
        })
    }]).controller("SignupCtrl", ["$scope", "Account", function (t, n) {
        t.info = {}, t.state = null, t.doRegister = function () {
            return t.info.email && t.info.code ? void(t.req = n.save(e.extend({registerType: "team", op: "register"}, t.info), function () {
                t.state = "ok"
            }, t.handleResourceError)) : t.showToast({msg: "信息没有填写完整", type: "error"})
        }
    }]).controller("CreateTeamCtrl", ["$scope", "Account", "Team", function (t, n, r) {
        t.team = {setting: {registerType: "invite"}}, t.user = config.login, t.invite = {addresses: [
            {}
        ]}, t.user.teamId && (t.step = "user", t.team = r.get({id: t.user.teamId})), t.stepTo = function (e) {
            t.step = e
        }, t.doCreateTeam = function () {
            r[t.user.teamId ? "put" : "save"](e.extend(t.team, {token: t.token}), function (e) {
                t.step = "user", t.team = e, "domain" === e.setting.registerType && (location.href = t.team.siteUrl)
            }, t.handleResourceError)
        }, t.doSaveUser = function () {
            n.put(e.extend(t.user, {id: "self", token: t.token, status: 1}), function () {
                t.step = "invite"
            }, t.handleResourceError)
        }, t.doInvite = function () {
            if (!t.hasInviteEmail())return void(location.href = t.team.siteUrl);
            var e = t.invite.addresses.filter(function (e) {
                return!!e.email
            }).map(function (e) {
                return e.email
            });
            r.save({id: t.team.id, op: "invites", emails: e, message: t.invite.message}).$promise.then(function () {
                location.href = t.team.siteUrl
            }, function () {
                location.href = t.team.siteUrl
            })
        }, t.hasInviteEmail = function () {
            return t.invite.addresses.filter(function (e) {
                return!!e.email
            }).length > 0
        }, t.toTeam = function () {
            location.href = t.team.siteUrl
        }, t.addInviteEmail = function () {
            t.invite.addresses.push({})
        }
    }]).controller("LoginCtrl", ["$scope", "$timeout", "User", function (t, n, r) {
        t.info = {}, t.state = null, t.stateRegisterOk = !1, t.stateRegister = !1, t.changeState = function (e) {
            t.state = e
        }, t.doStart = function () {
            t.req = r.save(e.extend({op: "check_email"}, t.info)), t.req.$promise.then(function (e) {
                e.exists ? t.state = "login" : e.allowRegister ? t.doRegister() : t.handleGlobalError("用户不存在，请联系管理员注册")
            }, t.handleResourceError)
        }, t.doRegister = function () {
            t.req = r.save(e.extend({registerType: "domain"}, t.info), function () {
                t.state = "registerOk"
            }, t.handleResourceError)
        }, t.doLogin = function () {
            t.req = r.save(e.extend({op: "login"}, t.info), function () {
                location.href = config.next || "/"
            }, t.handleResourceError)
        };
        var o = 0, i = null;
        t.smile = function () {
            return o++, i && n.cancel(i), 3 === o ? (o = 0, void(i = null)) : void(i = n(function () {
                o = 0, i = null
            }, 500))
        }
    }]).controller("RegCtrl", ["$scope", "User", function (t, n) {
        t.info = {}, t.state = null, t.doRegister = function () {
            t.req = n.save(e.extend({registerKey: config.registerKey, registerType: "key"}, t.info), function () {
                t.state = "ok"
            }, t.handleResourceError)
        }
    }]).controller("SetupCtrl", ["$scope", "$location", "User", "Upload", function (t, n, r, o) {
        t.infoSetup = config.login, t.onFileSelect = function (e) {
            var n = e[0];
            try {
                o(n, "pubuim/" + t.idLogin, {limit: 1048576, bucket: "facecdn"}).success(function (e) {
                    debug("Upload ok", e), t.infoSetup.avatarUrl = e.key
                }).error(t.handleGlobalError)
            } catch (r) {
                t.handleGlobalError(r)
            }
        }, t.doSetup = function () {
            r.put(e.extend(t.infoSetup, {id: "self", status: 1, _locale: config.locale})).$promise.then(function () {
                location.href = config.next || "/"
            }, t.handleResourceError)
        }
    }]).controller("ForgotCtrl", ["$scope", "User", function (e, t) {
        e.info = {}, e.state = !1, e.doStart = function () {
            e.req = t.save({op: "forgot", email: e.info.email}, function () {
                e.state = "sent"
            }, e.handleResourceError)
        }
    }]).controller("StartCtrl", ["$scope", "Team", "User", function (e, t) {
        e.teams = t.query(), e.doStart = function () {
            e.req = t.get({op: "check", name: e.name}, function (t) {
                t.url ? location.href = t.url : e.handleGlobalError("Not found")
            }, e.handleResourceError)
        }
    }])
}(angular), !function (e) {
    "use strict";
    function t(t, r) {
        this.configs = r, t.defaults.useXDomain = !0, delete t.defaults.headers.common["X-Requested-With"], this.$get = ["$resource", function (e) {
            return n(e, t, this)
        }], this.config = function (n) {
            if (n && e.isObject(n)) {
                var r = this;
                return e.forEach(n, function (e, t) {
                    r.configs[t] = e
                }), this.configs = o(this.configs), t.defaults.headers.common["X-AVOSCloud-Application-Id"] = this.configs.appId ? this.configs.appId : this.configs["X-AVOSCloud-Application-Id"], t.defaults.headers.common["X-AVOSCloud-Application-Key"] = this.configs.appKey ? this.configs.appKey : this.configs["X-AVOSCloud-Application-Key"], this.configs
            }
        }
    }

    function n(t, n, r) {
        var o = {login: "login", signin: "login", push: "push", sms: "requestSmsCode", msg: "requestSmsCode", rtm: "rtm/messages/logs", functions: "functions", feedback: "feedback", requestPasswordReset: "requestPasswordReset", resetPassword: "requestPasswordReset", requestEmailVerify: "requestEmailVerify", verifyEmail: "requestEmailVerify", requestMobilePhoneVerify: "requestMobilePhoneVerify", verifyPhone: "requestMobilePhoneVerify", requestLoginSmsCode: "requestLoginSmsCode", smsLogin: "requestLoginSmsCode", requestSmsCode: "requestSmsCode", verifyMobilePhone: "verifyMobilePhone/:code", verifySmsCode: "verifySmsCode/:code", classes: "classes/:className/:objectId", users: "users/:objectId/:action", roles: "roles/:objectId", installations: "installations/:objectId", stats: "stats/:type", batch: "batch"}, i = {};
        return e.forEach(o, function (e, n) {
            var o = {post: {method: "POST"}, update: {method: "PUT"}, put: {method: "PUT"}};
            i[n] = t(r.configs.host + e, null, o)
        }), i.headers = function (e, t) {
            return e && t ? (("session" === e || "sid" === e) && (e = "X-AVOSCloud-Session-Token"), n.defaults.headers.common[e] = t, n.defaults.headers) : void 0
        }, i
    }

    function r() {
        return o({protocol: "https", apiversion: 1.1, hostname: "cn.avoscloud.com"})
    }

    function o(e) {
        return e.host = e.protocol + "://" + e.hostname + "/" + e.apiversion + "/", e
    }

    if (!e)throw new Error("avoscloud.init(); angular.js required.");
    e.module("avoscloud", ["ngResource"]).constant("AVOSCLOUD_CONFIGS", r()).provider("avoscloud", ["$httpProvider", "AVOSCLOUD_CONFIGS", t])
}(window.angular), function (e) {
    "use strict";
    function t(e) {
        return{$setViewValue: function (e) {
            this.$viewValue = e
        }, $viewValue: e}
    }

    var n = window.debug("app:directive");
    e.module("pubu.directives", []).directive("log", function () {
        return{restrict: "AE", scope: {log: "=logData", option: "&logOption"}, replace: !0, templateUrl: "/templates/log_item", link: function (e) {
            e.openAside = e.$parent.openAside, e.openPreviewImage = e.$parent.openPreviewImage, e.goChannel = e.$parent.goChannel, e.users = e.$parent.users, e.channels = e.$parent.channels
        }}
    }).directive("avatar", function () {
        return{restrict: "AE", scope: {status: "=avatarStatus", user: "=avatarUser"}, replace: !0, templateUrl: "/templates/avatar_item", link: function (e, t, n) {
            e.size = n.avatarSize || 24, e["class"] = "avatar-" + e.size
        }}
    }).directive("tip", ["$timeout", function () {
        return{restrict: "AE", scope: {show: "=tipShow"}, replace: !0, templateUrl: "/templates/tip_tour_item", link: function (e, t, n) {
            var r = n.tipDom, o = $(r);
            e.title = n.tipTitle, e.content = n.tipContent, e.opts = {_stateShowTip: !0}, e.offset = o.offset()
        }}
    }]).directive("ngTourClick", function () {
        return{restrict: "A", link: function (e, t, n) {
            t.bind("click", function () {
                $(".tour-slides").animate({"margin-left": 640 * -(n.ngTourClick - 1)}, 500), 3 == n.ngTourClick ? $(".tour-slide-enter .btn").addClass("active") : $(".tour-slide-enter .btn").removeClass("active")
            })
        }}
    }).directive("pbDatepicker", function () {
        return{restrict: "A", require: "ngModel", replace: !0, transclude: !0, template: '<button bs-datepicker data-template="/templates/datepicker" data-autoclose="1" data-date-type="number" data-trigger="focus" ng-transclude></button>'}
    }).directive("pbAssigneeSelector", ["$popover", function (e) {
        var t = [];
        return{restrict: "A", scope: {id: "=pbAssigneeId", data: "=pbAssigneeData", channelId: "=pbAssigneeChannel", myId: "=pbAssigneeMyId", callback: "&pbAssigneeSelect"}, link: function (n, r, o) {
            function i(e) {
                n.id = e, o.pbAssigneeSelect && n.$parent.$eval(o.pbAssigneeSelect, {$id: e || null}), s.hide()
            }

            var s = e(r, {template: "/templates/assign_selector", placement: o.placement || "right"}), a = {};
            t.push(s), s.$scope.$on("tooltip.show.before", function () {
                t.forEach(function (e) {
                    e.hide()
                })
            }), s.$scope.$on("tooltip.hide.before", function () {
                s.$scope.selected = a[n.id] || "", s.$scope.id = n.id
            }), s.$scope.$on("$destroy", function () {
                var e = t.indexOf(s);
                -1 !== e && t.splice(e, 1)
            }), s.$scope.users = (n.data || n.$parent.listUsers || []).filter(function (e) {
                return n.currentChannel ? -1 !== n.currentChannel.usersIds.indexOf(e.id) && "robot" !== e.type : !0
            }).map(function (e) {
                return e.label = e.name, a[e.id] = e, e
            }), s.$scope.myId = n.myId || n.$parent.idLogin, n.$watch("id", function (e) {
                s.$scope.selected = a[e] || "", s.$scope.id = e
            }), s.$scope.valueChanged = function (e) {
                e && a[e.id] && i(e.id)
            }, s.$scope.valueClear = function () {
                s.$scope.selected = "", s.$scope.id = null, s.$element.find("input")[0].focus()
            }, s.$scope.assignToMe = function () {
                i(s.$scope.myId)
            }, s.$scope.assignDiscard = function () {
                i()
            }
        }}
    }]).provider("$button", function () {
        var e = this.defaults = {activeClass: "active", toggleEvent: "click"};
        this.$get = function () {
            return{defaults: e}
        }
    }).directive("bsRadioGroup", function () {
        return{restrict: "A", require: "ngModel", compile: function (t, n) {
            t.attr("data-toggle", "buttons"), t.removeAttr("ng-model");
            var r = t[0].querySelectorAll('input[type="radio"]');
            e.forEach(r, function (t) {
                e.element(t).attr("bs-radio", ""), e.element(t).attr("ng-model", n.ngModel)
            })
        }}
    }).directive("bsRadio", ["$button", "$$rAF", function (t, n) {
        var r = t.defaults, o = /^(true|false|\d+)$/;
        return{restrict: "A", require: "ngModel", link: function (t, i, s, a) {
            var c = r, u = "INPUT" === i[0].nodeName, l = u ? i.parent() : i, f = o.test(s.value) ? t.$eval(s.value) : s.value;
            a.$render = function () {
                var t = e.equals(a.$modelValue, f);
                n(function () {
                    u && (i[0].checked = t), l.toggleClass(c.activeClass, t)
                })
            }, i.bind(c.toggleEvent, function () {
                t.$apply(function () {
                    a.$setViewValue(f), a.$render()
                })
            })
        }}
    }]).directive("keepScroll", function () {
        return{controller: function () {
            var e = 0;
            this.setElement = function (t) {
                e = t
            }, this.addItem = function (t) {
                setTimeout(function () {
                    e && (e.scrollTop = e.scrollTop + t.clientHeight + 1)
                })
            }
        }, link: function (e, t, n, r) {
            r.setElement(t[0])
        }}
    }).directive("keepScrollItem", function () {
        return{require: "^keepScroll", link: function (e, t, n, r) {
            r.addItem(t[0])
        }}
    }).directive("compile", ["$compile", function (e) {
        return function (t, n, r) {
            t.$watch(function (e) {
                return e.$eval(r.compile)
            }, function (r) {
                n.html(r), e(n.contents())(t)
            })
        }
    }]).directive("ngReallyClick", function () {
        return{restrict: "A", link: function (e, t, n) {
            t.bind("click", function () {
                var t = n.ngReallyMessage;
                t && confirm(t) && e.$apply(n.ngReallyClick)
            })
        }}
    }).directive("checkScrollVisible", function () {
        function e(e) {
            var t, n, r;
            if (null != e.getBoundingClientRect)return e.getBoundingClientRect();
            for (r = 0, t = e; t;)r += t.offsetTop, t = t.offsetParent;
            for (n = e.parentElement; n;)null != n.scrollTop && (r -= n.scrollTop), n = n.parentElement;
            return{top: r, bottom: r + e.offsetHeight}
        }

        return{restrict: "A", link: function (t, n, r) {
            var o = e(n[0]);
            r.checkScrollVisibleDom && r.checkScrollVisible && n.bind("scroll", function () {
                var i = !1, s = !1;
                n.find(r.checkScrollVisibleDom).each(function () {
                    var t = e(this);
                    t.bottom < o.top ? i = !0 : t.top > o.bottom && (s = !0)
                }), t.$eval(r.checkScrollVisible, {$down: s, $up: i})
            })
        }}
    }).directive("focusOn", function () {
        return function (e, t, n) {
            return e.$on("focusOn", function (e, r) {
                return r === n.focusOn ? t[0].focus() : void 0
            })
        }
    }).directive("ngClickOutside", ["$timeout", function (e) {
        return{restrict: "A", link: function (t, n, r) {
            var o = !1, i = function () {
                return o ? void(o = !1) : (t.$eval(r.ngClickOutside), void t.$apply())
            }, s = function () {
                o = !0
            };
            e(function () {
                n.on("click", s), $("body").on("click", i)
            }), t.$on("$destroy", function () {
                $("body").off("click", i), n.off("click", s)
            })
        }}
    }]).directive("keyPress", ["keyHelper", function (e) {
        return{restrict: "A", link: function (t, n, r) {
            var o = e("press", t, r.hasOwnProperty("keyGlobal") ? $(window) : n, r);
            t.$on("$destroy", function () {
                o()
            })
        }}
    }]).directive("keyUp", ["keyHelper", function (e) {
        return{restrict: "A", link: function (t, n, r) {
            var o = e("up", t, r.hasOwnProperty("keyGlobal") ? $(window) : n, r);
            t.$on("$destroy", function () {
                o()
            })
        }}
    }]).directive("ngLoad", function () {
        return{restrict: "A", link: function (e, t, n) {
            var r = function () {
                e.$eval(n.ngLoad)
            };
            t.bind("load", r), e.$on("$destroy", function () {
                t.unbind("load", r)
            })
        }}
    }).directive("ngError", function () {
        return{restrict: "A", link: function (e, t, n) {
            var r = function () {
                e.$eval(n.ngError)
            };
            t.bind("error", r), e.$on("$destroy", function () {
                t.unbind("error", r)
            })
        }}
    }).directive("scrollGlue", function () {
        return{priority: 1, require: ["?ngModel"], restrict: "A", link: function (e, n, r, o) {
            function i() {
                a.scrollTop = a.scrollHeight
            }

            function s() {
                return a.scrollTop + a.clientHeight + 1 >= a.scrollHeight
            }

            var a = n[0], c = o[0] || t(!0);
            e.$watch(function () {
                c.$viewValue && i()
            }), n.bind("scroll", function () {
                var t = s();
                t !== c.$viewValue && e.$apply(c.$setViewValue.bind(c, t))
            })
        }}
    }).directive("whenScroll", function () {
        return function (e, t, n) {
            var r, o, i;
            n.hasOwnProperty("scrollGlobal") && (t = $(window));
            var s = function () {
                n.hasOwnProperty("scrollGlobal") ? (r = t.height(), o = t.scrollTop(), i = $(document.body).height()) : (r = t[0].offsetHeight, o = t[0].scrollTop, i = t[0].scrollHeight), e.$eval(n.whenScroll, {$pos: o / (i - r)})
            };
            t.bind("scroll", s), e.$on("$destroy", function () {
                t.unbind("scroll", s)
            })
        }
    }).directive("qnImg", ["Qiniu", function (t) {
        return{restrict: "A", link: function (r, o, i) {
            var s = i.qnImgType, a = function (a) {
                if (!a)return void i.$set(o.is("a") ? "href" : "src", "");
                var c;
                if (/^http(s)?\:\/\//.test(a))c = a; else if (e.isString(a))c = t.build(a, s); else if (a && a.size) {
                    var u = new FileReader;
                    try {
                        u.readAsDataURL(a), u.onload = function (e) {
                            r.$apply(function () {
                                i.$set("src", e.target.result)
                            })
                        }
                    } catch (l) {
                        n(l)
                    }
                    return
                }
                if (o.is("img")) {
                    i.$set("src", c);
                    var f, d = t.get(s);
                    if (i.qnImgMeta) {
                        var p = r.$eval(i.qnImgMeta);
                        if (p && p.image && p.image.width) {
                            var h = p.image.width, m = p.image.height, g = h <= d.w && m <= d.h ? 1 : Math.min(d.w / h, d.h / m);
                            f = {width: h * g, height: m * g}
                        }
                    }
                    f && o.css({width: f.width, height: f.height})
                } else o.is("a") && i.$set("href", c)
            };
            r.$watch(i.qnImg, a)
        }}
    }]).directive("ngWhenFocus", ["$timeout", function (e) {
        return{link: function (t, n, r) {
            t.$watch(r.ngWhenFocus, function (t) {
                var r = n;
                e(function () {
                    t ? r.is(":focus") || r.focus() : r.is(":focus") && r.blur()
                })
            })
        }}
    }]).directive("scrollFix", function () {
        return function (e, t) {
            var n = t.outerHeight(), r = function () {
                var e = t.parent().scrollTop(), r = 0;
                e >= 0 && n > e ? (r = n - e, t.css("top", r)) : e > n && t.css("top", 0)
            }, o = function () {
                t.parent().off("scroll", r)
            };
            t.parent().on("scroll", r), e.$on("$destroy", o)
        }
    }).factory("keyHelper", ["$parse", function (t) {
        var n = {8: "backspace", 9: "tab", 13: "enter", 27: "esc", 32: "space", 33: "pageup", 34: "pagedown", 35: "end", 36: "home", 37: "left", 38: "up", 39: "right", 40: "down", 45: "insert", 46: "delete"};
        return function (r, o, i, s) {
            var a, c = [], u = "key" + r.charAt(0).toUpperCase() + r.slice(1);
            r = "key" + r, a = o.$eval(s[u]), e.forEach(a, function (n, r) {
                var o, i;
                i = t(n), e.forEach(r.split(" "), function (t) {
                    o = {expression: i, keys: {}}, e.forEach(t.split("-"), function (e) {
                        o.keys[e] = !0
                    }), c.push(o)
                })
            });
            var l = function (t) {
                s.hasOwnProperty("keyPrevent") && (t.preventDefault(), t.stopPropagation());
                var i = !(!t.metaKey || t.ctrlKey), a = !!t.altKey, u = !!t.ctrlKey, l = !!t.shiftKey, f = t.keyCode;
                "keypress" === r && !l && f >= 97 && 122 >= f && (f -= 32), e.forEach(c, function (e) {
                    var r = e.keys[n[f]] || e.keys[f.toString()], s = !!e.keys.meta, c = !!e.keys.alt, d = !!e.keys.ctrl, p = !!e.keys.shift;
                    r && s === i && c === a && d === u && p === l && o.$apply(function () {
                        e.expression(o, {$event: t})
                    })
                })
            };
            return i.bind(r, l), function () {
                i.unbind(r, l)
            }
        }
    }])
}(angular), function (e) {
    "use strict";
    function t(e) {
        return e ? e.charAt(0).toUpperCase() + e.slice(1) : e
    }

    function n(e) {
        var t = -1, n = [" KB", " MB", " GB", " TB", "PB", "EB", "ZB", "YB"];
        do e /= 1024, t++; while (e > 1024);
        return Math.max(e, .1).toFixed(1) + n[t]
    }

    function r(e) {
        var t = moment(e), n = Date.now(), r = null;
        return r = t.format(t.isSame(n, "day") ? "HH:mm" : t.isSame(n - 864e5, "day") ? "昨天 HH:mm" : t.isSame(n, "month") ? "DD日 HH:mm" : t.isSame(n, "year") ? "M/D HH:mm" : "YY/M/D HH:mm")
    }

    function o(e, t) {
        return function () {
            return this[e] || (this[e] = t.apply(this)), this[e]
        }
    }

    e.module("pubu.services", ["ngResource", "ngResourceStore", "angularFileUpload"]).factory("Account", ["$resource2", function (e) {
        return e("/v1/accounts/:id/:op", {id: "@id", op: "@op"}, {put: {method: "PUT"}})
    }]).factory("Service", ["$resource2", function (e) {
        return e("/v1/services/:type/:op", {type: "@type", op: "@op"}, {put: {method: "PUT"}})
    }]).factory("Command", ["$resource2", function (e) {
        return e("/v1/channels/:id/commands", {id: "@id"})
    }]).factory("currentTeam", ["Team", function (e) {
        return e["new"](config.team)
    }]).factory("Team", ["$resource2", "$resourceStore", function (e, t) {
        var n = e("/v1/teams/:id/:op", {id: "@id", op: "@op"}, {put: {method: "PUT"}});
        return t(n)
    }]).factory("currentUser", ["User", function (e) {
        return e["new"](config.login)
    }]).factory("User", ["$resource2", "$resourceStore", "currentTeam", function (e, t, n) {
        var r = e("/v1/users/:id/:op", {op: "@op", id: "@id"}, {put: {method: "PUT"}});
        return r.prototype.hasPermission = function (e) {
            var t = n.permission[e];
            if (!t)return!1;
            switch (t) {
                case"admin":
                    return t === this.type;
                case"member":
                    return-1 !== ["admin", "member"].indexOf(this.type);
                case"guest":
                    return-1 !== ["admin", "member", "guest"].indexOf(this.type);
                default:
                    return!1
            }
        }, t(r)
    }]).factory("Channel", ["$resource2", "$resourceStore", function (e, t) {
        var n = e("/v1/channels/:id/:op/:subId", {id: "@id", op: "@op", subId: "@subId"}, {put: {method: "PUT"}}), i = t(n);
        return n.prototype.__defineGetter__("$created", o("$_created", function () {
            return r(this.created)
        })), i
    }]).factory("ChannelMeta", ["$resource2", function (e) {
        return e("/v1/channels/:channel/meta", {channel: "@channel"}, {put: {method: "PUT"}})
    }]).factory("Member", ["$resource2", function (e) {
        return e("/v1/channels/:channel/members/:id", {channel: "@channel", id: "@id"}, {put: {method: "PUT"}})
    }]).factory("Message", ["$resource2", "$resourceStore", "$injector", "$sce", function (e, n, i, s) {
        var a = e("/v1/messages/:id/:op", {id: "@id", op: "@op"}, {put: {method: "PUT"}}), c = n(a);
        return a.prototype.construct = function () {
            var e;
            "text" !== this.type && this[this.type] && (e = i.get(t(this.type)), e && (this[this.type] = e["new"](this[this.type]))), "comment" === this.type && this[this.comment.type] && (e = i.get(t(this.comment.type)), e && (this[this.comment.type] = e["new"](this[this.comment.type])))
        }, a.prototype.__defineGetter__("$string", o("$_string", function () {
            switch (this.type) {
                case"file":
                    return this.text + (this.text && " ") + "[文件]";
                case"task":
                    return"[任务]";
                case"voice":
                    return"[语音]";
                case"text":
                case"system":
                    var e = this.text ? this.text.replace(/\n/g, " ").replace(/<\/?[^>]+(>|$)/g, "").replace(/  /gm, " ").replace(/\[(.*?)\]\((\w+)\:(\w+)\)/gi, function (e, t, n) {
                        switch (n) {
                            case"user":
                                return t;
                            case"channel":
                                return t;
                            default:
                                return t
                        }
                    }) : "[空]";
                    return e.length > 50 ? e.substr(0, 50) + "..." : e;
                case"log":
                    return"[动态]";
                default:
                    return"消息"
            }
        })), a.prototype.__defineGetter__("$html", o("$_html", function () {
            var e = this.text.replace(/\t/g, "&nbsp;&nbsp;").replace(/ (?![^<]*>)/gm, " ").replace(/\n/g, "<br />").replace(/`(.*?)`/g, '<span class="highlight">$1</span>').replace(/(?:\*\*|__)(.*?)(?:\*\*|__)/g, "<strong>$1</strong>").replace(/(#([a-f0-9]{6}|[a-f0-9]{3})(?![a-f0-9]))/gi, '$1 <span style="background:$1;width:14px;height:14px;border:solid 1px #333;display:inline-block;margin-bottom:-2px"></span>').replace(/\[(.*?)\]\((\w+)\:(\w+)\)/gi, function (e, t, n, r) {
                switch (n) {
                    case"user":
                        return'<span class="mention" pb-contact-card="\'' + r + "'\">" + t + "</span>";
                    default:
                        return'<span class="mention">' + t + "</span>"
                }
            }).replace(/(^|[^"'])((([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,})))(?![^<]*>|[^<>]*<\/)/gim, '$1<a href="mailto:$2">$2</a>').replace(/(^|[^"'])((http|https):\/\/[\S]+(\b|$))/gim, function (e, t, n) {
                return t + '<a href="' + n + '" target="_blank" title="' + n + '">' + n + "</a>"
            }).replace(/<a href="(.*?)">([^<]+)<\/a>/gim, function (e, t, n) {
                return'<a href="' + t + '" target="_blank" title="' + n + '">' + n + "</a>"
            }), t = config.login.name || "";
            return t && (e = e.replace(new RegExp("(" + t.replace(/,/g, "|") + ")", "ig"), '<span class="highlight">$1</span>')), s.trustAsHtml(emojione.toImage(e))
        })), a.prototype.__defineGetter__("$created", o("$_created", function () {
            return r(this.created - (this.id ? 0 : 6e5))
        })), a.prototype.__defineGetter__("$created2", o("$_created2", function () {
            return this.$created.substr(-5)
        })), a.prototype.__defineGetter__("$attachments_html", o("$_attachments_html", function () {
            if (!this.attachments || 0 == this.attachments.length)return"";
            var e = [];
            return this.attachments.forEach(function (t) {
                e.push(['<div class="message-attach">', '<a class="message-preview preview-url ', t.color, '" target="_blank" href="', t.url, '">', '<div class="name text-ellipsis">', t.title, "</div>", t.description ? '<div class="meta">' + t.description.replace(/  /g, " ") + "</div>" : "", "</a>", "</div>"].join(""))
            }), s.trustAsHtml(e.join(""))
        })), c
    }]).factory("Task", ["$resource2", "$resourceStore", "File", function (e, t, n) {
        var r = e("/v1/tasks/:id/:op", {id: "@id", op: "@op"}, {put: {method: "PUT"}}), o = t(r);
        return r.prototype.hasSubTask = function () {
            return this.subtasks && this.subtasks.length > 0
        }, r.prototype.isFollowedBy = function (e) {
            return-1 !== this.followers.indexOf(e)
        }, r.prototype.toggleFollow = function (e) {
            if (e) {
                var t = this.followers.indexOf(e);
                -1 === t ? this.followers.push(e) : this.followers.splice(t, 1)
            }
        }, r.prototype.__defineGetter__("$model", function () {
            return"task"
        }), r.prototype.__defineGetter__("$followerIds", function () {
            return this.followers.join(",")
        }), r.prototype.__defineSetter__("$followerIds", function (e) {
            return this.followers = e.split(",")
        }), r.prototype.__defineGetter__("$tagsText", function () {
            return this.tags.join(",")
        }), r.prototype.__defineSetter__("$tagsText", function (e) {
            this.tags = e.split(",")
        }), r.prototype.construct = function () {
            var e = this;
            this.subtasks && this.subtasks.length && this.subtasks.forEach(function (t, n) {
                e.subtasks[n] = o["new"](t)
            }), this.files && this.files.length && this.files.forEach(function (t, r) {
                e.files[r] = n["new"](t)
            })
        }, o
    }]).factory("File", ["$resource2", "$resourceStore", "Util", function (e, t) {
        var i = e("/v1/files/:id/:op", {id: "@id", op: "@op"}, {put: {method: "PUT"}}), s = t(i);
        return i.prototype.__defineGetter__("$model", function () {
            return"file"
        }), i.prototype.__defineGetter__("$size", o("$_size", function () {
            return n(this.size)
        })), i.prototype.__defineGetter__("$created", o("$_created", function () {
            return r(this.created)
        })), i.prototype.isFollowedBy = function (e) {
            return-1 !== this.followers.indexOf(e)
        }, i.prototype.__defineGetter__("kind", function () {
            return-1 !== this.name.indexOf(".") ? this.name.split(".").pop().slice(0, 3) : "?"
        }), i.prototype.hasThumbnail = function () {
            return/^image\/(bmp|jpeg|pjpeg|gif|png|webp)$/.test(this.type)
        }, s
    }]).factory("Fav", ["$resource2", "$resourceStore", "$injector", function (n, r, o) {
        var i = n("/v1/favs/:id", {id: "@id"}), s = r(i);
        return i.prototype.construct = function () {
            var n = o.get(t(this.type));
            n && e.isObject(this.data) && (this.$object = n["new"](this.data), this.$object.uFav = !0)
        }, s
    }]).factory("Comment", ["$resource2", "$resourceStore", "$injector", function (e, t) {
        var n = e("/v1/comments/:op", {op: "@op"}), r = t(n);
        return r
    }]).factory("Stat", ["$resource2", function (e) {
        return e("/v1/stats/:op", {op: "@op"})
    }]).factory("Topic", ["$resource2", function (e) {
        return e("/v1/topics/:id", {id: "@id", op: "@op"})
    }]).factory("Search", ["$resource2", "$resourceStore", "$injector", function (n, r, o) {
        var i = n("/v1/search"), s = r(i);
        return i.prototype.construct = function () {
            var n = o.get(t(this.type));
            n && e.isObject(this.data) && (this.$object = n["new"](this.data))
        }, s
    }]).factory("Log", ["$resource2", "$resourceStore", function (e, t) {
        var n = e("/v1/logs");
        return t(n)
    }]).factory("Integration", ["$resource2", "$resourceStore", function (e, t) {
        var n = e("/v1/integrations/:id/:op", {id: "@id", op: "@op"}, {put: {method: "PUT"}});
        return n.prototype.__defineGetter__("$outgoingStrWords", function () {
            return this.outgoing && this.outgoing.words.join("\n")
        }), n.prototype.__defineSetter__("$outgoingStrWords", function (e) {
            return this.outgoing.words = e.split("\n")
        }), n.prototype.__defineGetter__("$outgoingStrUrls", function () {
            return this.outgoing && this.outgoing.urls.join("\n")
        }), n.prototype.__defineSetter__("$outgoingStrUrls", function (e) {
            this.outgoing.urls = e.split("\n")
        }), t(n)
    }]).factory("Passport", ["$resource2", "$resourceStore", function (e, t) {
        var n = e("/v1/passports/:id/:op", {id: "@id", op: "@op"}, {put: {method: "PUT"}});
        return t(n)
    }]).factory("Upload", ["$upload", "$rootScope", "Qiniu", "Util", function (t, n, r, o) {
        var i = {limit: 31457280, absolute: !1, bucket: "qiniu"};
        return function (n, s, a) {
            a = e.extend({}, i, a);
            var c = config[a.bucket + "Token"];
            if (!c)throw new Error("Unknown bucket: " + a.bucket);
            if (!n || n.size > a.limit)throw new Error("File is too large, limit to " + o.toReadableSize(a.limit));
            return t.upload({url: "https://up.qbox.me/", data: {token: c, key: a.absolute ? s : r.keygen(s)}, file: n}).progress(function (e) {
                n.$progress = Math.round(100 * e.loaded / e.total)
            })
        }
    }]).factory("UUID", function () {
        return{"new": function () {
            function e(e) {
                var t = (Math.random().toString(16) + "000000000").substr(2, 8);
                return e ? "-" + t.substr(0, 4) + "-" + t.substr(4, 4) : t
            }

            return e() + e(!0) + e(!0) + e()
        }, empty: function () {
            return"00000000-0000-0000-0000-000000000000"
        }}
    }).factory("Util", [function () {
        return{toReadableSize: n, calcWindowSize: function () {
            var e = $(window).width(), t = $(window).height(), n = e > 1200 ? 1200 : 800 > e ? 560 : e - 240, r = t > 700 ? 640 > e ? t - 80 : 620 : t - 80;
            return{width: n, height: r}
        }, escapeHtml: function (e) {
            var t = {"<": "&lt;", ">": "&gt;"};
            return String(e).replace(/(<|>)/g, function (e) {
                return t[e]
            })
        }, getFileKind: function (e) {
            var t = "?";
            return/^image\/\S+$/.test(e) ? t = "image" : "application/pdf" === e ? t = "pdf" : /(zip|compressed|rar|7z|gz)/i.test(e) ? t = "zip" : /(word|doc)/i.test(e) && (t = "doc"), t
        }}
    }]).factory("Qiniu", function () {
        var t = {}, n = {iv2: ["w", "h", "q", "format", "interlace"], im2: ["thumbnail", "gravity", "crop", "rotate", "interlace"]}, r = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        return{config: config.qiniu, keygen: function (t, n) {
            var o = "";
            e.isNumber(t) || (n = t, t = ""), t = t || 16, n = n + "/" || "";
            for (var i = 0; t > i; i++)o += r.charAt(Math.floor(Math.random() * r.length));
            return n + o
        }, define: function (e, n) {
            t[e] = n
        }, get: function (e) {
            return t[e]
        }, getBucket: function (e) {
            return e && this.get(e) && this.get(e).bucket
        }, url: function (e, t, n) {
            if (/^https?\:\/\//.test(e))return e;
            var r = this.getBucket(n), o = r ? config[r].domain : "/__";
            return o + "/" + e + (t ? "?attname=" + encodeURIComponent(t) : "")
        }, build: function (e, t) {
            if (/^https?\:\/\//.test(e))return e;
            var n = this.imageQuery(t), r = this.getBucket(t), o = r ? config[r].domain : "/__";
            return o + "/" + e + (n ? "?" + n : "")
        }, imageQuery: function (e) {
            var r = t[e], o = r && n[r.type];
            if (!r || !o)return null;
            var i = "", s = [];
            switch (r.type) {
                case"iv2":
                    i += "imageView2/" + (r.hasOwnProperty("mode") ? r.mode : 1);
                    break;
                case"im2":
                    i += "imageMogr2/auto-orient"
            }
            return o.forEach(function (e) {
                r[e] && s.push(e + "/" + r[e])
            }), 0 === s.length ? null : i + "/" + s.join("/")
        }}
    }).factory("$resource2", ["$resource", function (t) {
        var n = function (t, n) {
            var r, o = e.fromJson(t);
            return r = o && o.error ? o : o ? o.data || {} : {}, n().data = o, r
        }, r = {get: {method: "GET"}, save: {method: "POST"}, query: {method: "GET", isArray: !0}, remove: {method: "DELETE"}, "delete": {method: "DELETE"}};
        return function (o, i, s) {
            return s || (s = {}), s = e.extend(s, r), e.forEach(s, function (e, t) {
                e.transformResponse || (s[t].transformResponse = n), s[t].params = s[t].params || {}
            }), t(o, i, s)
        }
    }])
}(angular), function (e) {
    "use strict";
    var t = {}, n = {};
    e.module("pubu.filters", []).filter("readableSize", ["Util", function (e) {
        return function (t) {
            return e.toReadableSize(t)
        }
    }]).filter("trusted", ["$sce", function (t) {
        return function (n) {
            return e.isString(n) ? t.trustAsHtml(n) : n
        }
    }]).filter("emoji", ["$sce", function (e) {
        return function (t) {
            return e.trustAsHtml(emojione.toImage(t))
        }
    }]).filter("date2", ["Util", function () {
        return function (e) {
            if (!t[e]) {
                var n = moment(e), r = Date.now(), o = null;
                o = n.format(n.isSame(r, "day") ? "HH:mm" : n.isSame(r - 864e5, "day") ? "昨天 HH:mm" : n.isSame(r, "month") ? "DD日 HH:mm" : n.isSame(r, "year") ? "M/D HH:mm" : "YY/M/D HH:mm"), t[e] = o
            }
            return t[e]
        }
    }]).filter("deadline", ["Util", function () {
        return function (e) {
            if (!e)return"";
            if (!n[e]) {
                var t, r = moment(e), o = Date.now();
                t = r.format(r.isSame(o, "day") ? "今天" : r.isSame(o - 864e5, "day") ? "昨天" : r.isSame(o + 864e5, "day") ? "明天" : r.isSame(o + 1728e5, "day") ? "后天" : r.isSame(o, "year") ? "M月D日" : "YY年M月D日"), n[e] = t
            }
            return n[e]
        }
    }])
}(angular);