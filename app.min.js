!function (e) {
    "use strict";
    window.config.debug && window.debug.enable("app,app:*");
    var t = (window.debug("app"), window.app = e.module("pubu", ["ngRoute", "ngAnimate", "ngSanitize", "route-segment", "view-segment", "duScroll", "infinite-scroll", "cfp.hotkeys", "ui.jq", "oc.lazyLoad", "pubu.constants", "pubu.controllers", "pubu.services", "pubu.directives", "pubu.filters", "pubu.channel"]).config(["$controllerProvider", "$compileProvider", "$filterProvider", "$provide", function (e, n, i, o) {
        t.controller = e.register, t.directive = n.directive, t.filter = i.register, t.factory = o.factory, t.service = o.service, t.constant = o.constant, t.value = o.value
    }]).config(["$routeSegmentProvider", "$routeProvider", "$locationProvider", "$ocLazyLoadProvider", "hotkeysProvider", "$httpProvider", "$sceDelegateProvider", function (e, t, n, i, o, r) {
        o.cheatSheetDescription = "打开 / 关闭帮助", o.templateTitle = "快捷键列表", o.template = $("script[id='/templates/cheatsheet_hotkeys']").text(), r.defaults.timeout = 5e3, e.options.autoLoadTemplates = !0, e.when("/", "home").when("/messages/:id", "channel").when("/messages/:id/tasks", "channel.tasks").when("/messages/:id/files", "channel.files").when("/messages/:id/stars", "channel.stars").when("/messages/:id/activities", "channel.activities").segment("home", {templateUrl: "/templates/home", controller: "AppHomeCtrl"}).segment("channel", {controller: "AppChannelCtrl", dependencies: ["id"]}).within().segment("tasks", {templateUrl: "/templates/tasks", controller: "AppTaskCtrl"}).segment("files", {templateUrl: "/templates/files", controller: "AppFileCtrl"}).segment("stars", {templateUrl: "/templates/stars", controller: "AppStarCtrl"}).segment("activities", {templateUrl: "/templates/activities", controller: "AppLogCtrl"}), n.html5Mode(!0), t.otherwise({redirectTo: "/"})
    }]).run(["$rootScope", "$location", "$ocLazyLoad", "Qiniu", "Util", function (e, t, n, i, o) {
        var r = config.assets;
        n.load([
            {name: "pubu.delay", files: r["delay.js"].concat(r["delay.css"])},
            {name: "pubu.rtm", files: r["rtm.js"]}
        ]), e.$login = config.login, e.$config = config, e.$shared = {}, e.Util = o, e.Qiniu = i;
        var a = document.title;
        e.$windowSize = o.calcWindowSize(), e.setPageTitle = function (e) {
            document.title = e + " | " + a
        }, $(window).resize(function () {
            e.$windowSize = o.calcWindowSize(), e.$apply()
        }), e.isWindowActived = document.hasFocus ? document.hasFocus() : !1, i.define("avatar", {type: "iv2", mode: 1, w: 64, h: 64, bucket: "facecdn"}), i.define("bigavatar", {type: "iv2", mode: 1, w: 120, h: 120, bucket: "facecdn"}), i.define("thumbnail", {type: "iv2", mode: 1, w: 300, h: 120}), i.define("thumb", {type: "im2", mode: 0, w: 300, h: 240, thumbnail: "300x240"}), i.define("pasteimage", {type: "iv2", mode: 0, w: 180, h: 180}), emojione.imagePathSVGSprites = "/img/sprites/emojione.sprites.svg", emojione.imageType = "svg", e.isAppReady = !0
    }]))
}(angular), function (e) {
    "use strict";
    e.module("pubu.constants", []).constant("KEY", {BACKSPACE: 8, TAB: 9, RETURN: 13, ESC: 27, LEFT: 37, UP: 38, RIGHT: 39, DOWN: 40, COMMA: 188, SPACE: 32, HOME: 36, END: 35})
}(angular), function (e) {
    "use strict";
    function t(e) {
        return{$setViewValue: function (e) {
            this.$viewValue = e
        }, $viewValue: e}
    }

    var n = window.debug("app:directive");
    e.module("pubu.directives", []).directive("log", function () {
        return{restrict: "AE", scope: {log: "=logData", option: "&logOption"}, replace: !0, templateUrl: "/templates/log_item", link: function (e) {
            e.openAside = e.$parent.openAside, e.openPreviewImage = e.$parent.openPreviewImage, e.goChannel = e.$parent.goChannel, e.users = e.$parent.users, e.channels = e.$parent.channels
        }}
    }).directive("avatar", function () {
        return{restrict: "AE", scope: {status: "=avatarStatus", user: "=avatarUser"}, replace: !0, templateUrl: "/templates/avatar_item", link: function (e, t, n) {
            e.size = n.avatarSize || 24, e["class"] = "avatar-" + e.size
        }}
    }).directive("tip", ["$timeout", function () {
        return{restrict: "AE", scope: {show: "=tipShow"}, replace: !0, templateUrl: "/templates/tip_tour_item", link: function (e, t, n) {
            var i = n.tipDom, o = $(i);
            e.title = n.tipTitle, e.content = n.tipContent, e.opts = {_stateShowTip: !0}, e.offset = o.offset()
        }}
    }]).directive("ngTourClick", function () {
        return{restrict: "A", link: function (e, t, n) {
            t.bind("click", function () {
                $(".tour-slides").animate({"margin-left": 640 * -(n.ngTourClick - 1)}, 500), 3 == n.ngTourClick ? $(".tour-slide-enter .btn").addClass("active") : $(".tour-slide-enter .btn").removeClass("active")
            })
        }}
    }).directive("pbDatepicker", function () {
        return{restrict: "A", require: "ngModel", replace: !0, transclude: !0, template: '<button bs-datepicker data-template="/templates/datepicker" data-autoclose="1" data-date-type="number" data-trigger="focus" ng-transclude></button>'}
    }).directive("pbAssigneeSelector", ["$popover", function (e) {
        var t = [];
        return{restrict: "A", scope: {id: "=pbAssigneeId", data: "=pbAssigneeData", channelId: "=pbAssigneeChannel", myId: "=pbAssigneeMyId", callback: "&pbAssigneeSelect"}, link: function (n, i, o) {
            function r(e) {
                n.id = e, o.pbAssigneeSelect && n.$parent.$eval(o.pbAssigneeSelect, {$id: e || null}), a.hide()
            }

            var a = e(i, {template: "/templates/assign_selector", placement: o.placement || "right"}), s = {};
            t.push(a), a.$scope.$on("tooltip.show.before", function () {
                t.forEach(function (e) {
                    e.hide()
                })
            }), a.$scope.$on("tooltip.hide.before", function () {
                a.$scope.selected = s[n.id] || "", a.$scope.id = n.id
            }), a.$scope.$on("$destroy", function () {
                var e = t.indexOf(a);
                -1 !== e && t.splice(e, 1)
            }), a.$scope.users = (n.data || n.$parent.listUsers || []).filter(function (e) {
                return n.currentChannel ? -1 !== n.currentChannel.usersIds.indexOf(e.id) && "robot" !== e.type : !0
            }).map(function (e) {
                return e.label = e.name, s[e.id] = e, e
            }), a.$scope.myId = n.myId || n.$parent.idLogin, n.$watch("id", function (e) {
                a.$scope.selected = s[e] || "", a.$scope.id = e
            }), a.$scope.valueChanged = function (e) {
                e && s[e.id] && r(e.id)
            }, a.$scope.valueClear = function () {
                a.$scope.selected = "", a.$scope.id = null, a.$element.find("input")[0].focus()
            }, a.$scope.assignToMe = function () {
                r(a.$scope.myId)
            }, a.$scope.assignDiscard = function () {
                r()
            }
        }}
    }]).provider("$button", function () {
        var e = this.defaults = {activeClass: "active", toggleEvent: "click"};
        this.$get = function () {
            return{defaults: e}
        }
    }).directive("bsRadioGroup", function () {
        return{restrict: "A", require: "ngModel", compile: function (t, n) {
            t.attr("data-toggle", "buttons"), t.removeAttr("ng-model");
            var i = t[0].querySelectorAll('input[type="radio"]');
            e.forEach(i, function (t) {
                e.element(t).attr("bs-radio", ""), e.element(t).attr("ng-model", n.ngModel)
            })
        }}
    }).directive("bsRadio", ["$button", "$$rAF", function (t, n) {
        var i = t.defaults, o = /^(true|false|\d+)$/;
        return{restrict: "A", require: "ngModel", link: function (t, r, a, s) {
            var c = i, l = "INPUT" === r[0].nodeName, u = l ? r.parent() : r, d = o.test(a.value) ? t.$eval(a.value) : a.value;
            s.$render = function () {
                var t = e.equals(s.$modelValue, d);
                n(function () {
                    l && (r[0].checked = t), u.toggleClass(c.activeClass, t)
                })
            }, r.bind(c.toggleEvent, function () {
                t.$apply(function () {
                    s.$setViewValue(d), s.$render()
                })
            })
        }}
    }]).directive("keepScroll", function () {
        return{controller: function () {
            var e = 0;
            this.setElement = function (t) {
                e = t
            }, this.addItem = function (t) {
                setTimeout(function () {
                    e && (e.scrollTop = e.scrollTop + t.clientHeight + 1)
                })
            }
        }, link: function (e, t, n, i) {
            i.setElement(t[0])
        }}
    }).directive("keepScrollItem", function () {
        return{require: "^keepScroll", link: function (e, t, n, i) {
            i.addItem(t[0])
        }}
    }).directive("compile", ["$compile", function (e) {
        return function (t, n, i) {
            t.$watch(function (e) {
                return e.$eval(i.compile)
            }, function (i) {
                n.html(i), e(n.contents())(t)
            })
        }
    }]).directive("ngReallyClick", function () {
        return{restrict: "A", link: function (e, t, n) {
            t.bind("click", function () {
                var t = n.ngReallyMessage;
                t && confirm(t) && e.$apply(n.ngReallyClick)
            })
        }}
    }).directive("checkScrollVisible", function () {
        function e(e) {
            var t, n, i;
            if (null != e.getBoundingClientRect)return e.getBoundingClientRect();
            for (i = 0, t = e; t;)i += t.offsetTop, t = t.offsetParent;
            for (n = e.parentElement; n;)null != n.scrollTop && (i -= n.scrollTop), n = n.parentElement;
            return{top: i, bottom: i + e.offsetHeight}
        }

        return{restrict: "A", link: function (t, n, i) {
            var o = e(n[0]);
            i.checkScrollVisibleDom && i.checkScrollVisible && n.bind("scroll", function () {
                var r = !1, a = !1;
                n.find(i.checkScrollVisibleDom).each(function () {
                    var t = e(this);
                    t.bottom < o.top ? r = !0 : t.top > o.bottom && (a = !0)
                }), t.$eval(i.checkScrollVisible, {$down: a, $up: r})
            })
        }}
    }).directive("focusOn", function () {
        return function (e, t, n) {
            return e.$on("focusOn", function (e, i) {
                return i === n.focusOn ? t[0].focus() : void 0
            })
        }
    }).directive("ngClickOutside", ["$timeout", function (e) {
        return{restrict: "A", link: function (t, n, i) {
            var o = !1, r = function () {
                return o ? void(o = !1) : (t.$eval(i.ngClickOutside), void t.$apply())
            }, a = function () {
                o = !0
            };
            e(function () {
                n.on("click", a), $("body").on("click", r)
            }), t.$on("$destroy", function () {
                $("body").off("click", r), n.off("click", a)
            })
        }}
    }]).directive("keyPress", ["keyHelper", function (e) {
        return{restrict: "A", link: function (t, n, i) {
            var o = e("press", t, i.hasOwnProperty("keyGlobal") ? $(window) : n, i);
            t.$on("$destroy", function () {
                o()
            })
        }}
    }]).directive("keyUp", ["keyHelper", function (e) {
        return{restrict: "A", link: function (t, n, i) {
            var o = e("up", t, i.hasOwnProperty("keyGlobal") ? $(window) : n, i);
            t.$on("$destroy", function () {
                o()
            })
        }}
    }]).directive("ngLoad", function () {
        return{restrict: "A", link: function (e, t, n) {
            var i = function () {
                e.$eval(n.ngLoad)
            };
            t.bind("load", i), e.$on("$destroy", function () {
                t.unbind("load", i)
            })
        }}
    }).directive("ngError", function () {
        return{restrict: "A", link: function (e, t, n) {
            var i = function () {
                e.$eval(n.ngError)
            };
            t.bind("error", i), e.$on("$destroy", function () {
                t.unbind("error", i)
            })
        }}
    }).directive("scrollGlue", function () {
        return{priority: 1, require: ["?ngModel"], restrict: "A", link: function (e, n, i, o) {
            function r() {
                s.scrollTop = s.scrollHeight
            }

            function a() {
                return s.scrollTop + s.clientHeight + 1 >= s.scrollHeight
            }

            var s = n[0], c = o[0] || t(!0);
            e.$watch(function () {
                c.$viewValue && r()
            }), n.bind("scroll", function () {
                var t = a();
                t !== c.$viewValue && e.$apply(c.$setViewValue.bind(c, t))
            })
        }}
    }).directive("whenScroll", function () {
        return function (e, t, n) {
            var i, o, r;
            n.hasOwnProperty("scrollGlobal") && (t = $(window));
            var a = function () {
                n.hasOwnProperty("scrollGlobal") ? (i = t.height(), o = t.scrollTop(), r = $(document.body).height()) : (i = t[0].offsetHeight, o = t[0].scrollTop, r = t[0].scrollHeight), e.$eval(n.whenScroll, {$pos: o / (r - i)})
            };
            t.bind("scroll", a), e.$on("$destroy", function () {
                t.unbind("scroll", a)
            })
        }
    }).directive("qnImg", ["Qiniu", function (t) {
        return{restrict: "A", link: function (i, o, r) {
            var a = r.qnImgType, s = function (s) {
                if (!s)return void r.$set(o.is("a") ? "href" : "src", "");
                var c;
                if (/^http(s)?\:\/\//.test(s))c = s; else if (e.isString(s))c = t.build(s, a); else if (s && s.size) {
                    var l = new FileReader;
                    try {
                        l.readAsDataURL(s), l.onload = function (e) {
                            i.$apply(function () {
                                r.$set("src", e.target.result)
                            })
                        }
                    } catch (u) {
                        n(u)
                    }
                    return
                }
                if (o.is("img")) {
                    r.$set("src", c);
                    var d, f = t.get(a);
                    if (r.qnImgMeta) {
                        var p = i.$eval(r.qnImgMeta);
                        if (p && p.image && p.image.width) {
                            var h = p.image.width, m = p.image.height, g = h <= f.w && m <= f.h ? 1 : Math.min(f.w / h, f.h / m);
                            d = {width: h * g, height: m * g}
                        }
                    }
                    d && o.css({width: d.width, height: d.height})
                } else o.is("a") && r.$set("href", c)
            };
            i.$watch(r.qnImg, s)
        }}
    }]).directive("ngWhenFocus", ["$timeout", function (e) {
        return{link: function (t, n, i) {
            t.$watch(i.ngWhenFocus, function (t) {
                var i = n;
                e(function () {
                    t ? i.is(":focus") || i.focus() : i.is(":focus") && i.blur()
                })
            })
        }}
    }]).directive("scrollFix", function () {
        return function (e, t) {
            var n = t.outerHeight(), i = function () {
                var e = t.parent().scrollTop(), i = 0;
                e >= 0 && n > e ? (i = n - e, t.css("top", i)) : e > n && t.css("top", 0)
            }, o = function () {
                t.parent().off("scroll", i)
            };
            t.parent().on("scroll", i), e.$on("$destroy", o)
        }
    }).factory("keyHelper", ["$parse", function (t) {
        var n = {8: "backspace", 9: "tab", 13: "enter", 27: "esc", 32: "space", 33: "pageup", 34: "pagedown", 35: "end", 36: "home", 37: "left", 38: "up", 39: "right", 40: "down", 45: "insert", 46: "delete"};
        return function (i, o, r, a) {
            var s, c = [], l = "key" + i.charAt(0).toUpperCase() + i.slice(1);
            i = "key" + i, s = o.$eval(a[l]), e.forEach(s, function (n, i) {
                var o, r;
                r = t(n), e.forEach(i.split(" "), function (t) {
                    o = {expression: r, keys: {}}, e.forEach(t.split("-"), function (e) {
                        o.keys[e] = !0
                    }), c.push(o)
                })
            });
            var u = function (t) {
                a.hasOwnProperty("keyPrevent") && (t.preventDefault(), t.stopPropagation());
                var r = !(!t.metaKey || t.ctrlKey), s = !!t.altKey, l = !!t.ctrlKey, u = !!t.shiftKey, d = t.keyCode;
                "keypress" === i && !u && d >= 97 && 122 >= d && (d -= 32), e.forEach(c, function (e) {
                    var i = e.keys[n[d]] || e.keys[d.toString()], a = !!e.keys.meta, c = !!e.keys.alt, f = !!e.keys.ctrl, p = !!e.keys.shift;
                    i && a === r && c === s && f === l && p === u && o.$apply(function () {
                        e.expression(o, {$event: t})
                    })
                })
            };
            return r.bind(i, u), function () {
                r.unbind(i, u)
            }
        }
    }])
}(angular), function (e) {
    "use strict";
    function t(e) {
        return e ? e.charAt(0).toUpperCase() + e.slice(1) : e
    }

    function n(e) {
        var t = -1, n = [" KB", " MB", " GB", " TB", "PB", "EB", "ZB", "YB"];
        do e /= 1024, t++; while (e > 1024);
        return Math.max(e, .1).toFixed(1) + n[t]
    }

    function i(e) {
        var t = moment(e), n = Date.now(), i = null;
        return i = t.format(t.isSame(n, "day") ? "HH:mm" : t.isSame(n - 864e5, "day") ? "昨天 HH:mm" : t.isSame(n, "month") ? "DD日 HH:mm" : t.isSame(n, "year") ? "M/D HH:mm" : "YY/M/D HH:mm")
    }

    function o(e, t) {
        return function () {
            return this[e] || (this[e] = t.apply(this)), this[e]
        }
    }

    e.module("pubu.services", ["ngResource", "ngResourceStore", "angularFileUpload"]).factory("Account", ["$resource2", function (e) {
        return e("/v1/accounts/:id/:op", {id: "@id", op: "@op"}, {put: {method: "PUT"}})
    }]).factory("Service", ["$resource2", function (e) {
        return e("/v1/services/:type/:op", {type: "@type", op: "@op"}, {put: {method: "PUT"}})
    }]).factory("Command", ["$resource2", function (e) {
        return e("/v1/channels/:id/commands", {id: "@id"})
    }]).factory("currentTeam", ["Team", function (e) {
        return e["new"](config.team)
    }]).factory("Team", ["$resource2", "$resourceStore", function (e, t) {
        var n = e("/v1/teams/:id/:op", {id: "@id", op: "@op"}, {put: {method: "PUT"}});
        return t(n)
    }]).factory("currentUser", ["User", function (e) {
        return e["new"](config.login)
    }]).factory("User", ["$resource2", "$resourceStore", "currentTeam", function (e, t, n) {
        var i = e("/v1/users/:id/:op", {op: "@op", id: "@id"}, {put: {method: "PUT"}});
        return i.prototype.hasPermission = function (e) {
            var t = n.permission[e];
            if (!t)return!1;
            switch (t) {
                case"admin":
                    return t === this.type;
                case"member":
                    return-1 !== ["admin", "member"].indexOf(this.type);
                case"guest":
                    return-1 !== ["admin", "member", "guest"].indexOf(this.type);
                default:
                    return!1
            }
        }, t(i)
    }]).factory("Channel", ["$resource2", "$resourceStore", function (e, t) {
        var n = e("/v1/channels/:id/:op/:subId", {id: "@id", op: "@op", subId: "@subId"}, {put: {method: "PUT"}}), r = t(n);
        return n.prototype.__defineGetter__("$created", o("$_created", function () {
            return i(this.created)
        })), r
    }]).factory("ChannelMeta", ["$resource2", function (e) {
        return e("/v1/channels/:channel/meta", {channel: "@channel"}, {put: {method: "PUT"}})
    }]).factory("Member", ["$resource2", function (e) {
        return e("/v1/channels/:channel/members/:id", {channel: "@channel", id: "@id"}, {put: {method: "PUT"}})
    }]).factory("Message", ["$resource2", "$resourceStore", "$injector", "$sce", function (e, n, r, a) {
        var s = e("/v1/messages/:id/:op", {id: "@id", op: "@op"}, {put: {method: "PUT"}}), c = n(s);
        return s.prototype.construct = function () {
            var e;
            "text" !== this.type && this[this.type] && (e = r.get(t(this.type)), e && (this[this.type] = e["new"](this[this.type]))), "comment" === this.type && this[this.comment.type] && (e = r.get(t(this.comment.type)), e && (this[this.comment.type] = e["new"](this[this.comment.type])))
        }, s.prototype.__defineGetter__("$string", o("$_string", function () {
            switch (this.type) {
                case"file":
                    return this.text + (this.text && " ") + "[文件]";
                case"task":
                    return"[任务]";
                case"voice":
                    return"[语音]";
                case"text":
                case"system":
                    var e = this.text ? this.text.replace(/\n/g, " ").replace(/<\/?[^>]+(>|$)/g, "").replace(/  /gm, " ").replace(/\[(.*?)\]\((\w+)\:(\w+)\)/gi, function (e, t, n) {
                        switch (n) {
                            case"user":
                                return t;
                            case"channel":
                                return t;
                            default:
                                return t
                        }
                    }) : "[空]";
                    return e.length > 50 ? e.substr(0, 50) + "..." : e;
                case"log":
                    return"[动态]";
                default:
                    return"消息"
            }
        })), s.prototype.__defineGetter__("$html", o("$_html", function () {
            var e = this.text.replace(/\t/g, "&nbsp;&nbsp;").replace(/ (?![^<]*>)/gm, " ").replace(/\n/g, "<br />").replace(/`(.*?)`/g, '<span class="highlight">$1</span>').replace(/(?:\*\*|__)(.*?)(?:\*\*|__)/g, "<strong>$1</strong>").replace(/(#([a-f0-9]{6}|[a-f0-9]{3})(?![a-f0-9]))/gi, '$1 <span style="background:$1;width:14px;height:14px;border:solid 1px #333;display:inline-block;margin-bottom:-2px"></span>').replace(/\[(.*?)\]\((\w+)\:(\w+)\)/gi, function (e, t, n, i) {
                switch (n) {
                    case"user":
                        return'<span class="mention" pb-contact-card="\'' + i + "'\">" + t + "</span>";
                    default:
                        return'<span class="mention">' + t + "</span>"
                }
            }).replace(/(^|[^"'])((([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,})))(?![^<]*>|[^<>]*<\/)/gim, '$1<a href="mailto:$2">$2</a>').replace(/(^|[^"'])((http|https):\/\/[\S]+(\b|$))/gim, function (e, t, n) {
                return t + '<a href="' + n + '" target="_blank" title="' + n + '">' + n + "</a>"
            }).replace(/<a href="(.*?)">([^<]+)<\/a>/gim, function (e, t, n) {
                return'<a href="' + t + '" target="_blank" title="' + n + '">' + n + "</a>"
            }), t = config.login.name || "";
            return t && (e = e.replace(new RegExp("(" + t.replace(/,/g, "|") + ")", "ig"), '<span class="highlight">$1</span>')), a.trustAsHtml(emojione.toImage(e))
        })), s.prototype.__defineGetter__("$created", o("$_created", function () {
            return i(this.created - (this.id ? 0 : 6e5))
        })), s.prototype.__defineGetter__("$created2", o("$_created2", function () {
            return this.$created.substr(-5)
        })), s.prototype.__defineGetter__("$attachments_html", o("$_attachments_html", function () {
            if (!this.attachments || 0 == this.attachments.length)return"";
            var e = [];
            return this.attachments.forEach(function (t) {
                e.push(['<div class="message-attach">', '<a class="message-preview preview-url ', t.color, '" target="_blank" href="', t.url, '">', '<div class="name text-ellipsis">', t.title, "</div>", t.description ? '<div class="meta">' + t.description.replace(/  /g, " ") + "</div>" : "", "</a>", "</div>"].join(""))
            }), a.trustAsHtml(e.join(""))
        })), c
    }]).factory("Task", ["$resource2", "$resourceStore", "File", function (e, t, n) {
        var i = e("/v1/tasks/:id/:op", {id: "@id", op: "@op"}, {put: {method: "PUT"}}), o = t(i);
        return i.prototype.hasSubTask = function () {
            return this.subtasks && this.subtasks.length > 0
        }, i.prototype.isFollowedBy = function (e) {
            return-1 !== this.followers.indexOf(e)
        }, i.prototype.toggleFollow = function (e) {
            if (e) {
                var t = this.followers.indexOf(e);
                -1 === t ? this.followers.push(e) : this.followers.splice(t, 1)
            }
        }, i.prototype.__defineGetter__("$model", function () {
            return"task"
        }), i.prototype.__defineGetter__("$followerIds", function () {
            return this.followers.join(",")
        }), i.prototype.__defineSetter__("$followerIds", function (e) {
            return this.followers = e.split(",")
        }), i.prototype.__defineGetter__("$tagsText", function () {
            return this.tags.join(",")
        }), i.prototype.__defineSetter__("$tagsText", function (e) {
            this.tags = e.split(",")
        }), i.prototype.construct = function () {
            var e = this;
            this.subtasks && this.subtasks.length && this.subtasks.forEach(function (t, n) {
                e.subtasks[n] = o["new"](t)
            }), this.files && this.files.length && this.files.forEach(function (t, i) {
                e.files[i] = n["new"](t)
            })
        }, o
    }]).factory("File", ["$resource2", "$resourceStore", "Util", function (e, t) {
        var r = e("/v1/files/:id/:op", {id: "@id", op: "@op"}, {put: {method: "PUT"}}), a = t(r);
        return r.prototype.__defineGetter__("$model", function () {
            return"file"
        }), r.prototype.__defineGetter__("$size", o("$_size", function () {
            return n(this.size)
        })), r.prototype.__defineGetter__("$created", o("$_created", function () {
            return i(this.created)
        })), r.prototype.isFollowedBy = function (e) {
            return-1 !== this.followers.indexOf(e)
        }, r.prototype.__defineGetter__("kind", function () {
            return-1 !== this.name.indexOf(".") ? this.name.split(".").pop().slice(0, 3) : "?"
        }), r.prototype.hasThumbnail = function () {
            return/^image\/(bmp|jpeg|pjpeg|gif|png|webp)$/.test(this.type)
        }, a
    }]).factory("Fav", ["$resource2", "$resourceStore", "$injector", function (n, i, o) {
        var r = n("/v1/favs/:id", {id: "@id"}), a = i(r);
        return r.prototype.construct = function () {
            var n = o.get(t(this.type));
            n && e.isObject(this.data) && (this.$object = n["new"](this.data), this.$object.uFav = !0)
        }, a
    }]).factory("Comment", ["$resource2", "$resourceStore", "$injector", function (e, t) {
        var n = e("/v1/comments/:op", {op: "@op"}), i = t(n);
        return i
    }]).factory("Stat", ["$resource2", function (e) {
        return e("/v1/stats/:op", {op: "@op"})
    }]).factory("Topic", ["$resource2", function (e) {
        return e("/v1/topics/:id", {id: "@id", op: "@op"})
    }]).factory("Search", ["$resource2", "$resourceStore", "$injector", function (n, i, o) {
        var r = n("/v1/search"), a = i(r);
        return r.prototype.construct = function () {
            var n = o.get(t(this.type));
            n && e.isObject(this.data) && (this.$object = n["new"](this.data))
        }, a
    }]).factory("Log", ["$resource2", "$resourceStore", function (e, t) {
        var n = e("/v1/logs");
        return t(n)
    }]).factory("Integration", ["$resource2", "$resourceStore", function (e, t) {
        var n = e("/v1/integrations/:id/:op", {id: "@id", op: "@op"}, {put: {method: "PUT"}});
        return n.prototype.__defineGetter__("$outgoingStrWords", function () {
            return this.outgoing && this.outgoing.words.join("\n")
        }), n.prototype.__defineSetter__("$outgoingStrWords", function (e) {
            return this.outgoing.words = e.split("\n")
        }), n.prototype.__defineGetter__("$outgoingStrUrls", function () {
            return this.outgoing && this.outgoing.urls.join("\n")
        }), n.prototype.__defineSetter__("$outgoingStrUrls", function (e) {
            this.outgoing.urls = e.split("\n")
        }), t(n)
    }]).factory("Passport", ["$resource2", "$resourceStore", function (e, t) {
        var n = e("/v1/passports/:id/:op", {id: "@id", op: "@op"}, {put: {method: "PUT"}});
        return t(n)
    }]).factory("Upload", ["$upload", "$rootScope", "Qiniu", "Util", function (t, n, i, o) {
        var r = {limit: 31457280, absolute: !1, bucket: "qiniu"};
        return function (n, a, s) {
            s = e.extend({}, r, s);
            var c = config[s.bucket + "Token"];
            if (!c)throw new Error("Unknown bucket: " + s.bucket);
            if (!n || n.size > s.limit)throw new Error("File is too large, limit to " + o.toReadableSize(s.limit));
            return t.upload({url: "https://up.qbox.me/", data: {token: c, key: s.absolute ? a : i.keygen(a)}, file: n}).progress(function (e) {
                n.$progress = Math.round(100 * e.loaded / e.total)
            })
        }
    }]).factory("UUID", function () {
        return{"new": function () {
            function e(e) {
                var t = (Math.random().toString(16) + "000000000").substr(2, 8);
                return e ? "-" + t.substr(0, 4) + "-" + t.substr(4, 4) : t
            }

            return e() + e(!0) + e(!0) + e()
        }, empty: function () {
            return"00000000-0000-0000-0000-000000000000"
        }}
    }).factory("Util", [function () {
        return{toReadableSize: n, calcWindowSize: function () {
            var e = $(window).width(), t = $(window).height(), n = e > 1200 ? 1200 : 800 > e ? 560 : e - 240, i = t > 700 ? 640 > e ? t - 80 : 620 : t - 80;
            return{width: n, height: i}
        }, escapeHtml: function (e) {
            var t = {"<": "&lt;", ">": "&gt;"};
            return String(e).replace(/(<|>)/g, function (e) {
                return t[e]
            })
        }, getFileKind: function (e) {
            var t = "?";
            return/^image\/\S+$/.test(e) ? t = "image" : "application/pdf" === e ? t = "pdf" : /(zip|compressed|rar|7z|gz)/i.test(e) ? t = "zip" : /(word|doc)/i.test(e) && (t = "doc"), t
        }}
    }]).factory("Qiniu", function () {
        var t = {}, n = {iv2: ["w", "h", "q", "format", "interlace"], im2: ["thumbnail", "gravity", "crop", "rotate", "interlace"]}, i = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        return{config: config.qiniu, keygen: function (t, n) {
            var o = "";
            e.isNumber(t) || (n = t, t = ""), t = t || 16, n = n + "/" || "";
            for (var r = 0; t > r; r++)o += i.charAt(Math.floor(Math.random() * i.length));
            return n + o
        }, define: function (e, n) {
            t[e] = n
        }, get: function (e) {
            return t[e]
        }, getBucket: function (e) {
            return e && this.get(e) && this.get(e).bucket
        }, url: function (e, t, n) {
            if (/^https?\:\/\//.test(e))return e;
            var i = this.getBucket(n), o = i ? config[i].domain : "/__";
            return o + "/" + e + (t ? "?attname=" + encodeURIComponent(t) : "")
        }, build: function (e, t) {
            if (/^https?\:\/\//.test(e))return e;
            var n = this.imageQuery(t), i = this.getBucket(t), o = i ? config[i].domain : "/__";
            return o + "/" + e + (n ? "?" + n : "")
        }, imageQuery: function (e) {
            var i = t[e], o = i && n[i.type];
            if (!i || !o)return null;
            var r = "", a = [];
            switch (i.type) {
                case"iv2":
                    r += "imageView2/" + (i.hasOwnProperty("mode") ? i.mode : 1);
                    break;
                case"im2":
                    r += "imageMogr2/auto-orient"
            }
            return o.forEach(function (e) {
                i[e] && a.push(e + "/" + i[e])
            }), 0 === a.length ? null : r + "/" + a.join("/")
        }}
    }).factory("$resource2", ["$resource", function (t) {
        var n = function (t, n) {
            var i, o = e.fromJson(t);
            return i = o && o.error ? o : o ? o.data || {} : {}, n().data = o, i
        }, i = {get: {method: "GET"}, save: {method: "POST"}, query: {method: "GET", isArray: !0}, remove: {method: "DELETE"}, "delete": {method: "DELETE"}};
        return function (o, r, a) {
            return a || (a = {}), a = e.extend(a, i), e.forEach(a, function (e, t) {
                e.transformResponse || (a[t].transformResponse = n), a[t].params = a[t].params || {}
            }), t(o, r, a)
        }
    }])
}(angular), function (e) {
    "use strict";
    var t = {}, n = {};
    e.module("pubu.filters", []).filter("readableSize", ["Util", function (e) {
        return function (t) {
            return e.toReadableSize(t)
        }
    }]).filter("trusted", ["$sce", function (t) {
        return function (n) {
            return e.isString(n) ? t.trustAsHtml(n) : n
        }
    }]).filter("emoji", ["$sce", function (e) {
        return function (t) {
            return e.trustAsHtml(emojione.toImage(t))
        }
    }]).filter("date2", ["Util", function () {
        return function (e) {
            if (!t[e]) {
                var n = moment(e), i = Date.now(), o = null;
                o = n.format(n.isSame(i, "day") ? "HH:mm" : n.isSame(i - 864e5, "day") ? "昨天 HH:mm" : n.isSame(i, "month") ? "DD日 HH:mm" : n.isSame(i, "year") ? "M/D HH:mm" : "YY/M/D HH:mm"), t[e] = o
            }
            return t[e]
        }
    }]).filter("deadline", ["Util", function () {
        return function (e) {
            if (!e)return"";
            if (!n[e]) {
                var t, i = moment(e), o = Date.now();
                t = i.format(i.isSame(o, "day") ? "今天" : i.isSame(o - 864e5, "day") ? "昨天" : i.isSame(o + 864e5, "day") ? "明天" : i.isSame(o + 1728e5, "day") ? "后天" : i.isSame(o, "year") ? "M月D日" : "YY年M月D日"), n[e] = t
            }
            return n[e]
        }
    }])
}(angular), function (e) {
    "use strict";
    var t = window.debug("app");
    e.module("pubu.controllers", []).controller("AppCtrl", ["$scope", "$rootScope", "$timeout", "$location", "$routeSegment", "$q", "$window", "User", "Team", "Channel", "Member", "ChannelMeta", "Message", "Command", "Fav", "Topic", "File", "currentUser", "currentTeam", "hotkeys", "Qiniu", function (t, n, i, o, r, a, s, c, l, u, d, f, p, h, m, g, v, w, y, b, C) {
        function k(e, n) {
            var i = "T" + t.idTeam;
            t.$pubu.child(i + e).on(["child.create", "child.update", "child.delete"], function (e) {
                t.broadcast(n + ".received", "child." + e.message.action, e)
            })
        }

        function S(e, n) {
            var i, o, r = $("[data-cid]").map(function () {
                return $(this).data("cid")
            }).get();
            n && (r = r.filter(function (e) {
                return t.channels[e] && t.channels[e].uHasUnread
            }));
            var a = r.indexOf(t.idChannel);
            -1 !== a && ("up" === e ? (i = a - 1, 0 > i && (i = r.length - 1)) : (i = a + 1, i >= r.length && (i = 0)), o = r[i], o && t.goChannel(o))
        }

        function M(e, n) {
            return u.save({id: t.idChannel, type: e, oid: n, op: "topic"})
        }

        function A() {
            return u["delete"]({id: t.idChannel, op: "topic"})
        }

        function I(e) {
            return g.get({id: e})
        }

        function x(e) {
            t.ioOnlineChild && (R("Set online", e), t.ioOnlineChild.set(t.$pubu.sid, e))
        }

        function U(e) {
            return-1 !== t.loadedChannels.indexOf(e)
        }

        function P(e) {
            return d.query({channel: e}).$promise.then(function (e) {
                e.forEach(function (e) {
                    E(c["new"](e), !0)
                })
            })
        }

        function T(n) {
            if (e.isArray(n))return n.forEach(T);
            if (n && n.id && n.type) {
                var i = t.channels[n.id];
                !n.topicId || i && n.topicId === i.topicId ? i && i.topicId && !n.topicId && delete t.topics[n.id] : t.topics[n.id] = I(n.topicId), i ? e.extend(i, n) : (t.channels[n.id] = n, t.listChannels.push(t.channels[n.id]))
            }
        }

        function _(n) {
            var i = e.isObject(n) ? n.id : n, o = t.channels[i];
            if (o) {
                var r = t.listChannels.indexOf(o);
                -1 !== r && t.listChannels.splice(r, 1), delete t.channels[i], delete t.topics[i]
            }
        }

        function E(n, i) {
            if (e.isArray(n))return n.forEach(E);
            if (n && n.id) {
                var o = n.id, r = t.users[o];
                return i && r ? r : (t.users[o] = r ? e.extend(r, n) : n, o === t.idLogin && (t.currentUser = t.users[o]), r || t.listUsers.push(t.users[o]), t.users[o])
            }
        }

        function L(n) {
            return e.isArray(n) ? n.forEach(L) : void(n && n.id && (t.teams[n.id] = n, t.listTeams.push(t.teams[n.id])))
        }

        function D(e, n) {
            var i = {channel: e};
            return i[n] = !0, R("Update user time", e, n), f.put(i).$promise.then(function (i) {
                return R("Update user time success", e, n, i[n]), t.channels[e].uMeta = i, i
            })
        }

        var R = window.debug("app:team"), O = window.debug("app:page");
        t.currentTeam = y, t.currentUser = w, t.idTeam = t.currentTeam.id, t.idLogin = t.$login.id, t.listChannels = [], t.channels = {}, t.listTeams = [], t.teams = {}, t.listUsers = [], t.users = {}, t.topics = {}, t.commands = {}, t.listAllTasks = {}, t.listMessages = {}, t.loadedChannels = [], t.srcPreviewImage = null, t.newMessages = {}, t.listPreviewImages = [], t.isAutoScroll = !0, t.stateReady = !1, t.isWindowActived = !0, t.stateShowMask = !1, t.stateHideImgLoading = !1, t.stateFocus = null, t.isShowMiniChat = !0, t.isSidebarFolded = !1, t.isAsideModuleFull = !1, t.countUserUnread = 0, t.scopePanel = {}, t.aside = {hide: !0}, t.toast = {}, t.cbPreviewImage = null, t.addChannels = T, t.deleteChannel = _, t.moveChannel = S, t.addUser = E, t.setOnline = x, t.ioOnlineChild = null, t.doSetChannelMeta = D, t.isChannelLoaded = U, t.doSetTopic = M, t.doDelTopic = A;
        var F = {};
        E(t.currentUser), t.broadcast = function () {
            t.$broadcast.apply(t, arguments)
        };
        var H = function () {
            k("/users", "user"), k("/channels", "channel"), k("/onlines", "online"), k("/C*/messages", "message")
        };
        t.$pubu ? H() : t.$on("pubu.connect", H), a.all([c.query().$promise.then(function (e) {
            R("Loaded users", e.length), E(e)
        }), u.query(F).$promise.then(function (e) {
            R("Loaded channels", e.length), T(e), t.isChannelsLoaded = !0, t.broadcast("channel.loaded")
        })]).then(function () {
            t.$shared.stateReady = t.stateReady = !0, t.$shared.showTips = t.currentUser.setting.showTips, R("App ready"), t.$broadcast("app.ready"), t.currentUser.setting.showTips || (R("Mark user show tips after 3s"), i(function () {
                R("User show tips has been marked"), c.put({id: t.idLogin, setting: e.extend(t.currentUser.setting, {showTips: !0})})
            }, 3e3))
        }, t.handleResourceError), l.query().$promise.then(function (e) {
            L(e), R("Loaded teams", e.length)
        });
        var N, q = function () {
            N && clearInterval(N);
            var e = t.ioOnlineChild = t.$pubu.child("T" + t.idTeam + "/U" + t.idLogin + "/clients");
            x(1), N = setInterval(function () {
                x(t.currentUser.online > 0 ? t.currentUser.online : 1)
            }, 6e4), e.multi()["delete"](t.$pubu.sid).defer()
        };
        t.$pubu ? q() : t.$on("pubu.connect", q), t.$on("user.received", function (e, t, n) {
            var i = n.value;
            switch (R("User received", t, n), t) {
                case"child.create":
                case"child.update":
                    E(c["new"](i))
            }
        }), t.$on("channel.received", function (e, t, n) {
            var i = n.value;
            switch (R("Channel received", t, n), t) {
                case"child.create":
                case"child.update":
                    R("您加入了频道", i.id), u.get({id: i.id}, T);
                    break;
                case"child.delete":
                    _(n.snapshot)
            }
        }), t.$on("online.received", function (e, n, i) {
            var o = i.value, r = i.name;
            switch (R("Online received", n, i), n) {
                case"child.create":
                case"child.update":
                    if (!t.users[r])return;
                    t.users[r].online = o
            }
        }), t.$on("message.received", function (o, r, a) {
            R("Message received", r, a);
            var s = "child.delete" === r ? a.snapshot : a.value;
            s = p["new"](s);
            var c = s.channelId, l = t.channels[c];
            if (l) {
                var u = s.creatorId ? t.users[s.creatorId] : s.robot, d = -1, f = t.listMessages[c];
                if ("child.create" === r && t.isWindowActived && s.channelId !== t.idChannel && "person" === t.channels[s.channelId].type && s.creatorId && s.creatorId !== t.idLogin && t.addQuickChat(s), "child.delete" === r) {
                    if (!f)return;
                    for (var h = 0; h < f.length; ++h)(f[h].id == s.id || f[h].meta && s.meta && s.meta.clientId && f[h].meta.clientId === s.meta.clientId) && f.splice(h--, 1)
                } else if ("child.create" === r) {
                    if (!t.isWindowActived && s.creatorId !== t.idLogin) {
                        var m = !1;
                        if (l.uMeta.muted)return;
                        var g = !1, v = Date.now();
                        switch (("person" === l.type || s.mentions && -1 !== s.mentions.indexOf(t.idLogin) || "channel" === s.broadcast) && (t.countUserUnread++, g = !0), l.uMeta.notify) {
                            case"all":
                                m = !0;
                                break;
                            case"mention":
                                g && (m = !0);
                                break;
                            case"smart":
                                (!l.$lastNotifyTime || l.$lastNotifyTime - v > 1e4 || f && f[f.length - 1].creatorId === t.idLogin) && (l.$lastNotifyTime = v, m = !0)
                        }
                        if (!m)return;
                        var $ = "", w = ("person" !== l.type ? "#" + l.title + " " : "") + u.name + ":";
                        switch (s.type) {
                            case"text":
                            case"system":
                                $ = s.$string;
                                break;
                            case"file":
                                $ = t.$config.locales["LABEL.PREFIX_UPLOAD"] + s.$string;
                                break;
                            case"voice":
                            case"task":
                                $ = t.$config.locales["LABEL.PREFIX_SEND"] + s.$string;
                                break;
                            case"log":
                                $ = t.$config.locales["LABEL.PREFIX_UPDATE"] + s.$string
                        }
                        window.macgap ? (window.macgap.notice.notify({title: w, content: $, sound: t.currentUser.setting.sound}), window.macgap.dock.badge = "" + (t.countUserUnread || "")) : new Notify(w, {body: $, tag: "message", icon: C.build(u.avatarUrl, "avatar"), timeout: 5, notifyShow: function () {
                            R("Notify ok"), i(function () {
                                t.currentUser.setting.sound && n.$emit("sound.play")
                            })
                        }, notifyClick: function () {
                            R("Notify clicked"), t.goChannel(l.id)
                        }}).show()
                    }
                    s.id && (!t.isWindowActived || l.id !== t.idChannel) && s.created > l.uMeta.readTime && s.creatorId !== t.idLogin && (l.uHasUnread && l.uNewPos || (l.uNewPos = s.id), R("Set unread", l.id), l.uHasUnread = !0, ("person" === l.type || s.mentions && -1 !== s.mentions.indexOf(t.idLogin)) && l.uUnreadCount++)
                }
                f && -1 !== ["child.create", "child.update"].indexOf(r) && (e.forEach(f, function (t, n) {
                    (t.id === s.id || t.meta && s.meta && t.meta.clientId && t.meta.clientId === s.meta.clientId) && (f[n] = e.extend(f[n], s), d = n)
                }), -1 === d && f.push(s))
            }
        }), $(window).blur(function () {
            t.isWindowActived && (t.isWindowActived = !1, R("Window deactive"), t.$broadcast("app.deactive"), t.$apply())
        }), $(window).focus(function () {
            t.isWindowActived || (t.isWindowActived = !0, R("Window active"), t.$broadcast("app.active"), t.$apply())
        }), t.$watch("$windowSize", function (e) {
            e && (t.isSidebarFolded = e.width > 900 ? !1 : !0)
        });
        var Q = null, j = !1;
        t.$on("app.deactive", function () {
            R("Set away timer"), Q = setTimeout(function () {
                R("Set away ok"), x(2), j = !0, Q = null
            }, 3e5)
        }), t.$on("app.active", function () {
            Q && (R("Cancel auto away"), clearTimeout(Q), Q = null), j && (j = !1, R("Auto online"), x(1)), t.countUserUnread = 0, window.macgap && (window.macgap.notice.close("*"), window.macgap.dock.badge = "")
        }), b.add({combo: "/", description: "Search", callback: function () {
            t.broadcast("start.search")
        }}), b.add({combo: "shift+esc", description: "Mark all read", allowIn: ["input", "select", "textarea"], callback: function () {
            Object.keys(t.channels).forEach(function (e) {
                t.channels[e].uHasUnread && t.doSetChannelMeta(e, "readTime").then(function (n) {
                    n && (t.channels[e].uHasUnread = !1, t.channels[e].uUnreadCount = 0)
                })
            })
        }}), b.add({combo: "mod+/", description: "Search", allowIn: ["input", "select", "textarea"], callback: function () {
            t.broadcast("start.search")
        }}), b.add({combo: "mod+[", description: "Back", allowIn: ["input", "select", "textarea"], callback: function () {
            s.history.back()
        }}), b.add({combo: "mod+]", description: "Forward", allowIn: ["input", "select", "textarea"], callback: function () {
            s.history.forward()
        }}), b.add({combo: "option+up", description: "Previous channel", allowIn: ["input", "select", "textarea"], callback: function () {
            S("up")
        }}), b.add({combo: "option+down", description: "Next channel", allowIn: ["input", "select", "textarea"], callback: function () {
            S("down")
        }}), b.add({combo: "option+shift+up", description: "Previous unread channel", allowIn: ["input", "select", "textarea"], callback: function () {
            S("up", !0)
        }}), b.add({combo: "option+shift+down", description: "Next unread channel", allowIn: ["input", "select", "textarea"], callback: function () {
            S("down", !0)
        }}), b.add({combo: "n", description: "Quick chat", callback: function () {
            t.broadcast("start.sendbox")
        }}), t.listQucikChats = [], t.currentQuickChat = null, t.currentQuickChatReply = "", t.timerQuickChat = null, t.$on("$locationChangeSuccess", function () {
            R("Location change success");
            var e = o.path().match(/messages\/(\w+)/);
            e && (R("Channel changed: " + e[1]), t.idChannel = e[1], t.broadcast("channel.changed", e[1]))
        }), t.isChannel = function (e) {
            return-1 !== o.path().indexOf("messages/" + e)
        }, t.addQuickChat = function (e) {
            t.listQucikChats.push(e), t.popQuickChat()
        }, t.removeQuickChat = function () {
            t.currentQuickChat = null, t.popQuickChat()
        }, t.keepQuickChat = function () {
            t.timerQuickChat && i.cancel(t.timerQuickChat)
        }, t.sendQuickChat = function () {
            t.currentQuickChat.$replyMessage && (p.save({type: "text", text: t.currentQuickChat.$replyMessage, channel: t.currentQuickChat.channelId}), t.removeQuickChat())
        }, t.leftQuickChat = function () {
            t.timerQuickChat && i.cancel(t.timerQuickChat), t.timerQuickChat = i(function () {
                t.removeQuickChat()
            }, 5e3)
        }, t.popQuickChat = function () {
            t.currentQuickChat = t.listQucikChats[0], t.currentQuickChat && (t.listQucikChats.splice(0, 1), t.leftQuickChat())
        }, b.add({combo: "mod+enter", description: "Quick reply", allowIn: ["input", "select", "textarea"], callback: function () {
            t.currentQuickChat.$isReply = !0, t.focusOn("quickchat"), t.keepQuickChat()
        }}), t.toggleCheatSheet = function () {
            b.toggleCheatSheet()
        }, t.focusOn = function (e, n) {
            n && n.preventDefault(), i(function () {
                return t.$broadcast("focusOn", e)
            })
        }, t.goChannel = function (e) {
            R("Go channel " + e), o.url(r.getSegmentUrl("channel", {id: e}))
        }, t["goto"] = function (e, t) {
            o.url(r.getSegmentUrl(e, t))
        }, t.debug = function () {
            O.apply(void 0, arguments)
        }, t.goTeam = function (e) {
            t.teams[e] && confirm('Confirm switch team to "' + t.teams[e].title + '"?') && (location.href = t.teams[e].siteUrl)
        }, t.doLoadChannel = function (n, i) {
            R("Loading channel " + n);
            var o = [];
            return t.currentChannel = t.channels[n], t.setPageTitle("person" === t.currentChannel.type ? t.users[t.currentChannel.toId].name : t.currentChannel.title), e.forEach(t.channels, function (e) {
                e.$isLoading && (e.$isLoading = !1)
            }), t.currentChannel.$isLoading = !0, i && o.push(i()), -1 === t.loadedChannels.indexOf(n) ? (R("Channel load", n), o.push(h.get({id: n}).$promise.then(function (e) {
                t.commands[n] = e, t.loadedChannels.push(n)
            }))) : R("Channel loaded", n), a.all(o)["finally"](function () {
                t.currentChannel.$isLoading = !1
            })
        }, t.doJoinChannel = function (e) {
            R("Join channel", e), u.save({id: e, op: "members", user: "self"}, function (n) {
                R("Join channel success", e), T(n), P(e), t.goChannel(e)
            }, t.handleResourceError)
        }, t.doPubuReconnect = function () {
            R("Reconnect"), t.$pubu && t.$pubu.socket.io.connect()
        }, t.doTalkWith = function (e) {
            R("Start talk", e), u.save({type: "person", to: e}, function (e) {
                R("Success talk", e.id), T(e), t.goChannel(e.id), t.hidePanel()
            }, t.handleResourceError)
        }, t.doLeaveChannel = function (e) {
            R("Leave channel", e), confirm('Leave "' + t.channels[e].title + '"?') && d["delete"]({channel: e, id: "self"}, function () {
                R("Leave channel success", e), S("up"), _(e), t.idChannel === e && (t.idChannel = !1)
            }, t.handleResourceError)
        }, t.openPanel = function (e, n) {
            return t.srcPanel ? (t.hidePanel(), void i(function () {
                t.openPanel(e, n)
            }, 250)) : (n = n || {}, t.scopePanel = n, t.srcPanel = "/templates/" + e, void t.openMask())
        }, t.hidePanel = function () {
            t.srcPanel = "", t.scopePanel = {}, t.hideMask()
        }, t.openAside = function (e, n) {
            function o() {
                t.aside.name = e, t.aside.url = "/templates/aside_" + e, t.aside.id = n, t.aside.hide = !1
            }

            t.aside.name ? (t.hideAside(), i(o)) : o()
        }, t.hideAside = function () {
            t.aside.url = null, t.aside.id = null, t.aside.name = null, i(function () {
                t.aside.hide = !0
            }, 250)
        }, t.openPreviewImage = function (e, n) {
            e = e.kind ? e : v["new"](e), R("Open preview", e), t.openMask(), t.stateHideImgLoading = !1, t.srcPreviewImage = e, t.cbPreviewImage = null, t.listPreviewImages = [], "function" == typeof n ? t.cbPreviewImage = n : t.listPreviewImages = n
        };
        var z;
        t.showToast = function (e, n) {
            t.toast = e, z && i.cancel(z), z = i(function () {
                t.hideToast(), z = null
            }, void 0 === n ? 3e3 : n)
        }, t.hideToast = function () {
            t.toast = null
        }, t.getPreviewImage = function (e) {
            if (t.srcPreviewImage && t.listPreviewImages && 0 !== t.listPreviewImages.length) {
                var n = t.listPreviewImages.indexOf(t.srcPreviewImage);
                if (-1 !== n)return t.listPreviewImages[e ? n + 1 : n - 1]
            }
        }, t.hasPreviewImage = function (e) {
            return!!t.getPreviewImage(e)
        }, t.slidePreviewImage = function (e) {
            var n = t.getPreviewImage(e);
            n && (t.srcPreviewImage = null, i(function () {
                t.srcPreviewImage = n
            }))
        }, t.hidePreviewImage = function (e) {
            e && (e.preventDefault(), e.stopPropagation()), t.srcPreviewImage = null, t.hideMask(), t.isShowPreviewToolBar = !1, t.cbPreviewImage && (t.cbPreviewImage(), t.cbPreviewImage = null)
        };
        var B;
        t.showPreviewToolbar = function () {
            t.srcPreviewImage && (t.isShowPreviewToolBar = !0, B && i.cancel(B), B = i(function () {
                t.isShowPreviewToolBar = !1
            }, 3e3))
        }, t.toggleSidebar = function () {
            t.isSidebarFolded = !t.isSidebarFolded
        }, t.toggleAsideModule = function (e) {
            t.isAsideModuleFull = "boolean" == typeof e ? e : !t.isAsideModuleFull
        }, t.openMask = function () {
            t.stateShowMask = !0
        }, t.hideMask = function () {
            t.stateShowMask = !1
        }, t.doToggleFav = function (e, n) {
            e && !e.$isProcessFav && (e.$isProcessFav = !0, R("Star", n, e.id, !e.uFav), e.uFav = !e.uFav, e.uFav ? m.save({type: n, oid: e.id}, function () {
                R("Success star", n, e.id), t.broadcast(n + ".fav", e), e.uFav = !0
            }, function () {
                e.uFav = !1
            }).$promise["finally"](function () {
                delete e.$isProcessFav
            }) : m["delete"]({type: n, oid: e.id}, function () {
                R("Canceled star", n, e.id), t.broadcast(n + ".unfav", e), e.uFav = !1
            }, function () {
                e.uFav = !0
            }).$promise["finally"](function () {
                delete e.$isProcessFav
            }))
        }, t.handleGlobalError = function (e) {
            t.showToast({msg: e, type: "error"})
        }, t.handleUploadError = function (e) {
            t.handleGlobalError(e.message)
        }, t.handleResourceError = function (e) {
            var n = "请求错误，请稍后再试";
            e.data && e.data.message && "string" == typeof e.data.message && (n = e.data.message), t.handleGlobalError(n)
        }
    }]).controller("AppHomeCtrl", ["$scope", function (n) {
        function i() {
            if (!n.idChannel) {
                var t = e.copy(n.listChannels).sort(function (e, t) {
                    return t.uMeta.readTime - e.uMeta.readTime
                })[0];
                t || (t = n.listChannels[0]), n.goChannel(t.id)
            }
        }

        t("Enter AppHomeCtrl"), n.isChannelsLoaded ? i() : n.$on("channel.loaded", i)
    }]).controller("AppProjectToolbarCtrl", ["$scope", "Channel", function (e, t) {
        e.doChangeColor = function (n) {
            t.put({id: e.idChannel, setting: {colorLabel: n}})
        }
    }]).controller("AppSearchCtrl", ["$scope", "$timeout", "Search", "KEY", function (n, i, o, r) {
        function a(e) {
            d.type = e, s(n.keyword)
        }

        function s(r) {
            return f && (t("cancel"), i.cancel(f), f = null), r ? void(f = i(function () {
                n.httpRequest = o.query(e.extend({channelId: n.idChannel || Object.keys(n.channels), q: r}, d), function (e) {
                    n.isShowResults = !0, n.results = e, n.isEmpty = n.results.length ? !1 : !0
                }, function () {
                    n.isShowResults = !0, n.isEmpty = !0
                }), n.indexSelected = 0
            }, 300)) : void u()
        }

        function c() {
            n.isActived = !0, i(function () {
                n.focusOn("searchbox")
            })
        }

        function l() {
            n.isActived = !1, n.forceActived = !1, u()
        }

        function u() {
            n.keyword = null, n.indexSelected = 0, n.results = [], n.httpRequest = null, n.isShowResults = !1, n.isEmpty = !1
        }

        var d = {};
        u(), n.query = d, n.doChangeType = a, n.handleInput = function (e) {
            if (!e.shiftKey && !e.ctrlKey) {
                switch (e.keyCode) {
                    case r.UP:
                        n.indexSelected--;
                        break;
                    case r.DOWN:
                        n.indexSelected++;
                        break;
                    case r.RETURN:
                        return void n.openItem(n.results[n.indexSelected]);
                    case r.ESC:
                        n.forceActived || l();
                        break;
                    default:
                        return
                }
                n.indexSelected < 0 ? n.indexSelected = n.results.length - 1 : n.indexSelected > n.results.length - 1 && (n.indexSelected = 0), e.preventDefault()
            }
        }, n.$on("start.search", c), n.openItem = function (e) {
            switch (t("Open search item", e), e.type) {
                case"file":
                    n.forceActived = !0, n.openPreviewImage(e.data, function () {
                        n.isActived = !0, n.forceActived = !1
                    });
                    break;
                case"message":
                    n.broadcast("chat.indicate", e.id), l()
            }
        };
        var f;
        n.$watch("keyword", s), n.$watch("isActived", function (e, t) {
            e !== t && e && n.focusOn("searchbox")
        })
    }]).controller("CoSCtrl", ["$scope", "Upload", function (t, n) {
        var i = window.debug("app:cosc");
        t.newUser = e.copy(t.currentUser), t.newUser.markSaved(), t.$watch("newUser.setting.uiChatLayout", function (e, n) {
            e !== n && (t.currentUser.setting.uiChatLayout = e)
        }), t.doSave = function () {
            var n = t.newUser.isChanged("setting.locale");
            t.newUser.save().$promise.then(function (i) {
                e.extend(t.currentUser, i), n ? location.href = location.href : t.hidePanel()
            })
        }, t.onFileSelect = function (e) {
            var o = e[0];
            try {
                n(o, "pubuim/" + t.idLogin, {limit: 1048576, bucket: "facecdn"}).success(function (e) {
                    i("上传成功", e), t.newUser.avatarUrl = e.key, t.newUser.nameAbbr = ""
                }).error(t.handleUploadError)
            } catch (r) {
                t.handleUploadError(r)
            }
        }
    }]).controller("CCCtrl", ["$scope", "Channel", function (t, n) {
        t.newChannel = {type: t.scopePanel.type || "project", visibility: 0, title: "", description: ""}, t.originNewChannel = e.copy(t.newChannel), t.isChanged = function () {
            return!e.equals(t.newChannel, t.originNewChannel)
        }, t.doCreate = function () {
            t.httpRequest = n.save(t.newChannel, function (e) {
                t.addChannels(e), t.hidePanel(), t.goChannel(e.id)
            }, t.handleResourceError)
        }
    }]).controller("PreviewCtrl", ["$scope", "hotkeys", function (e, t) {
        t.bindTo(e).add({combo: "left", description: "Previous image", callback: function () {
            e.slidePreviewImage()
        }}).add({combo: "right", description: "Next image", callback: function () {
            e.slidePreviewImage(!0)
        }})
    }]).controller("PreviewCommentCtrl", ["$scope", "hotkeys", "Comment", function (t, n, i) {
        function o() {
            return a ? void i.query({type: "file", oid: a.id}, function (e, n) {
                t.countComment = n("data").count, r(e)
            }) : void(t.listComments = [])
        }

        function r(n) {
            if (e.isArray(n))return n.forEach(r);
            n.created > s.from && (s.from = n.created);
            var i = -1;
            t.listComments.forEach(function (o, r) {
                o.id === n.id && (e.extend(t.listComments[r], o), i = r)
            }), -1 === i && t.listComments.push(n)
        }

        var a = t.srcPreviewImage, s = {};
        t.listComments = [], t.newComment = "", t.countComment = 0, o(), t.focusOn("comment"), t.$watch("srcPreviewImage", function () {
            o()
        }), t.doComment = function () {
            i.save({type: "file", oid: a.id, text: t.newComment}, function (e) {
                t.newComment = "", r(e)
            }, t.handleResourceError)
        }
    }]).controller("ChannelsCtrl", ["$scope", "Channel", function (t, n) {
        function i(i) {
            t.listAllChannels = n.query(e.extend(i, a))
        }

        function o(e) {
            n.put({id: e, archived: !1}).$promise.then(function (e) {
                for (var n = 0; n < t.listAllChannels.length; n++)t.listAllChannels[n].id === e.id && t.listAllChannels.splice(n--, 1)
            })
        }

        var r = t.scopePanel.type || "project", a = t.query = {type: r};
        t.viewMode = 0, t.doRestore = o, i({all: !0}), t.doChangeViewMode = function (e) {
            t.viewMode = e, i(e ? {archived: !0} : {all: !0})
        }
    }]).controller("SidebarCtrl", ["$scope", "User", function (e) {
        e.stateSidebarTab = "channels", e.changeSidebarTab = function (t) {
            e.stateSidebarTab = t
        }
    }]).controller("SidebarContactsCtrl", ["$scope", "User", function () {
    }]).controller("UserInviteCtrl", ["$scope", "User", "currentUser", function (t, n, i) {
        t.newUser = {registerType: "invite", type: "guest" === i.type ? "guest" : "member"}, t.isChanged = function () {
            return!e.equals(t.newUser, {})
        }, t.doAdd = function () {
            t.httpRequest = n.save(t.newUser), t.httpRequest.$promise.then(function (e) {
                e && (t.addUser(e), t.newUser = {registerType: "invite", type: "guest" === i.type ? "guest" : "member"}, t.form.$setPristine(), t.showToast({msg: "添加成功：" + e.email, type: "info"}))
            }, t.handleResourceError)
        }
    }]).controller("CSCtrl", ["$scope", "Channel", function (t, n) {
        function i() {
            return t.listUsers.filter(function (e) {
                return-1 === t.currentChannel.usersIds.indexOf(e.id) && "robot" !== e.type
            })
        }

        var o = t.channels[t.idChannel];
        t.colors = ["#808b96", "#f05858", "#fd7550", "#fed130", "#38de3e", "#6d8cf3", "#a96df3", "#f15685"], t.selectUser = "", t.selectUsers = i(), t.newChannel = {id: t.idChannel, visibility: o.visibility, title: o.title, description: o.description, meta: o.meta, setting: o.setting}, t.addUser = function (o) {
            o && !e.isString(o) && (t.req = n.save({id: t.idChannel, op: "members", user: o.id}, function (e) {
                t.selectedUser = "", t.selectUsers = i(), t.addChannels(e)
            }, t.handleResourceError))
        }, t.originNewChannel = e.copy(t.newChannel), t.isChanged = function () {
            return!e.equals(t.newChannel, t.originNewChannel)
        }, t.doRemoveMember = function (e) {
            n["delete"]({id: t.idChannel, op: "members", subId: e.id}).$promise.then(function (e) {
                t.selectUsers = i(), t.addChannels(e)
            })
        }, t.doSave = function () {
            t.httpRequest = n.put(t.newChannel, function (n) {
                t.channels[t.idChannel] = e.extend(o, n), t.hidePanel()
            }, t.handleResourceError)
        }, t.doArchive = function () {
            confirm("归档项目后只能访问历史数据，确定？") && (t.httpRequest = n["delete"]({id: t.newChannel.id}, function (e) {
                t.currentChannel.id === e.id && t.moveChannel("up"), t.deleteChannel(e), t.showToast({msg: "归档的频道可以在「项目」列表找到。", type: "info"})
            }, t.handleResourceError))
        }
    }]).controller("NSCtrl", ["$scope", "Channel", function (t, n) {
        t.meta = t.channels[t.idChannel].uMeta, t.originMeta = e.copy(t.meta), t.isChanged = function () {
            return!e.equals(t.meta, t.originMeta)
        }, t.doSave = function () {
            t.httpRequest = n.put(e.extend({id: t.idChannel, op: "meta"}, t.meta), function () {
                t.hidePanel()
            }, t.handleResourceError)
        }
    }])
}(angular), angular.module("ngDraggable", []).directive("ngDrag", ["$rootScope", "$parse", function (e, t) {
    return{restrict: "A", link: function (n, i, o) {
        n.value = o.ngDrag;
        var r, a, s, c, l, u = "ontouchstart"in document.documentElement, d = "touchstart mousedown", f = "touchmove mousemove", p = "touchend mouseup", h = $(document), m = $(window), g = null, v = !1, w = null, y = t(o.ngDragSuccess) || null, b = function () {
            i.attr("draggable", "false"), k(!0)
        }, C = function () {
            return!1
        }, k = function (e) {
            e ? (n.$on("$destroy", S), o.$observe("ngDrag", A), n.$watch(o.ngDragData, M), i.on(d, I), u || i.on("mousedown", C)) : (i.off(d, I), u || i.off("mousedown", C))
        }, S = function () {
            k(!1)
        }, M = function (e) {
            g = e
        }, A = function (e) {
            v = n.$eval(e)
        }, I = function (e) {
            v && (x(), w = setTimeout(function () {
                x(), U(e)
            }, 100), h.on(f, x), h.on(p, x))
        }, x = function () {
            clearTimeout(w), h.off(f, x), h.off(p, x)
        }, U = function (t) {
            v && (t.preventDefault(), r = i.offset(), i.centerY = i.height() / 2, i.addClass("dragging"), a = t.pageX || t.originalEvent.touches[0].pageX, s = t.pageY || t.originalEvent.touches[0].pageY, c = a - 10 - m.scrollLeft(), l = s - i.centerY - m.scrollTop(), L(c, l), h.on(f, P), h.on(p, T), e.$broadcast("draggable:start", {x: a, y: s, tx: c, ty: l, element: i, data: g}), o.ngDragBegin && (n.$eval(o.ngDragBegin, {$data: g}), n.$apply()))
        }, P = function (t) {
            v && (t.preventDefault(), a = t.pageX || t.originalEvent.touches[0].pageX, s = t.pageY || t.originalEvent.touches[0].pageY, c = a - 10 - m.scrollLeft(), l = s - i.centerY - m.scrollTop(), L(c, l), e.$broadcast("draggable:move", {x: a, y: s, tx: c, ty: l, element: i, data: g}))
        }, T = function (t) {
            v && (t.preventDefault(), e.$broadcast("draggable:end", {x: a, y: s, tx: c, ty: l, element: i, data: g, callback: _}), i.removeClass("dragging"), E(), h.off(f, P), h.off(p, T), o.ngDragEnd && (n.$eval(o.ngDragEnd, {$data: g}), n.$apply()))
        }, _ = function (e) {
            y && n.$apply(function () {
                y(n, {$data: g, $event: e})
            })
        }, E = function () {
            i.css({left: "", top: "", position: "", "z-index": ""})
        }, L = function (e, t) {
            i.css({left: e, top: t, position: "fixed", "z-index": 9999})
        };
        b()
    }}
}]).directive("ngDrop", ["$parse", "$timeout", function (e, t) {
    return{restrict: "A", link: function (e, n, i) {
        e.value = i.ngDrop;
        var o = !1, r = null, a = !1, s = function () {
            c(!0)
        }, c = function (t) {
            t && (i.$observe("ngDrop", u), e.$watch(i.ngDropData, h), e.$on("$destroy", l), e.$on("draggable:start", d), e.$on("draggable:move", f), e.$on("draggable:end", p))
        }, l = function () {
            c(!1)
        }, u = function (t) {
            o = e.$eval(t)
        }, d = function (e, t) {
            o && m(t.x, t.y, t.element)
        }, f = function (t, n) {
            if (o) {
                var s = m(n.x, n.y, n.element);
                s ? (a = !0, i.ngDropMove && (e.$eval(i.ngDropMove, {$pos: s, $data: n.data, $dropData: r, $obj: n}), e.$apply())) : a && (a = !1, i.ngDropOut && (e.$eval(i.ngDropOut, {$pos: s, $data: n.data, $dropData: r, $obj: n}), e.$apply()))
            }
        }, p = function (n, a) {
            if (o) {
                var s = m(a.x, a.y, a.element);
                s && (a.callback && a.callback(n), t(function () {
                    e.$eval(i.ngDropSuccess, {$pos: s, $data: a.data, $event: n, $dropData: r})
                })), g(!1, a.element)
            }
        }, h = function (e) {
            r = e
        }, m = function (e, t, n) {
            var i = v(e, t);
            return g(i, n), i
        }, g = function (e, t) {
            e ? (n.addClass("drag-enter"), t.addClass("drag-over")) : (n.removeClass("drag-enter"), t.removeClass("drag-over"))
        }, v = function (e, t) {
            var i = n.offset();
            i.right = i.left + n.outerWidth(), i.bottom = i.top + n.outerHeight();
            var o = e >= i.left && e <= i.right && t <= i.bottom && t >= i.top;
            if (!o)return!1;
            var r = i.bottom - i.top, a = i.right - i.left, s = (e - i.left) / a, c = (t - i.top) / r;
            return{px: s, py: c, dx: e - i.left, dy: t - i.top}
        };
        s()
    }}
}]).directive("ngDragClone", ["$parse", "$timeout", function () {
    return{restrict: "A", link: function (e, t) {
        var n;
        e.clonedData = {};
        var i = function () {
            n = $(t.find("img")), t.attr("draggable", "false"), n.attr("draggable", "false"), c(), o(!0)
        }, o = function (t) {
            t ? (e.$on("draggable:start", r), e.$on("draggable:move", a), e.$on("draggable:end", s), n.off("mousedown touchstart touchmove touchend touchcancel", u), n.on("mousedown touchstart touchmove touchend touchcancel", u)) : n.off("mousedown touchstart touchmove touchend touchcancel", u)
        }, r = function (n, i) {
            e.$apply(function () {
                e.clonedData = i.data
            }), t.css("width", i.element.height()), t.css("height", i.element.height()), l(i.tx, i.ty)
        }, a = function (e, t) {
            l(t.tx, t.ty)
        }, s = function () {
            c()
        }, c = function () {
            t.css({left: 0, top: 0, position: "fixed", "z-index": -1, visibility: "hidden"})
        }, l = function (e, n) {
            t.css({left: e, top: n, position: "fixed", "z-index": 99999, visibility: "visible"})
        }, u = function (e) {
            var t = e.originalEvent;
            return t.preventDefault && t.preventDefault(), t.stopPropagation && t.stopPropagation(), t.cancelBubble = !0, t.returnValue = !1, !1
        };
        i()
    }}
}]).directive("ngPreventDrag", ["$parse", "$timeout", function () {
    return{restrict: "A", link: function (e, t) {
        var n = function () {
            t.attr("draggable", "false"), i(!0)
        }, i = function (e) {
            e ? t.on("mousedown touchstart touchmove touchend touchcancel", o) : t.off("mousedown touchstart touchmove touchend touchcancel", o)
        }, o = function (e) {
            var t = e.originalEvent;
            return t.preventDefault && t.preventDefault(), t.stopPropagation && t.stopPropagation(), t.cancelBubble = !0, t.returnValue = !1, !1
        };
        n()
    }}
}]), function (e) {
    "use strict";
    var t = window.debug("app:channel"), n = app.channel = e.module("pubu.channel", ["ngDraggable"]).config(["$controllerProvider", "$compileProvider", "$filterProvider", "$provide", function (e, t, i, o) {
        n.controller = e.register, n.directive = t.directive, n.filter = i.register, n.factory = o.factory, n.service = o.service, n.constant = o.constant, n.value = o.value
    }]);
    n.controller("AppChannelCtrl", ["$scope", function (e) {
        function n() {
            e.idChannel && (t("Active AppChannelCtrl"), e.stateReady ? i() : e.$on("app.ready", i))
        }

        function i() {
            e.doLoadChannel(e.idChannel)
        }

        t("Load AppChannelCtrl"), n(), e.$on("channel.changed", n)
    }]).controller("AppProjectMemberCtrl", ["$scope", "$timeout", "$q", "Qiniu", function () {
    }]).controller("AppChatCtrl", ["$scope", "$timeout", "$routeSegment", "User", "Team", "Channel", "Message", function (t, n, i, o, r, a, s) {
        function c() {
            t.idChannel && (C("Active AppChatCtrl: " + t.idChannel), y && (S && n.cancel(S), k && n.cancel(k), M && n.cancel(M), t.listMessages[y] = t.listCurrent.slice(-20), t.currentChannel && (t.currentChannel.uNewPos = null)), y = t.idChannel, b = {team: t.idTeam, channel: y}, k = null, t.listMessages[y] || (t.listMessages[y] = []), t.listCurrent = t.listMessages[y], h(), l(), t.listCurrent.length && 1 === t.$connected ? t.isMessageReady = !0 : (t.showToast({type: "info", msg: t.$config.locales["MESSAGE.LOADING_MESSAGES"]}), u().then(function () {
                k = n(function () {
                    C("After message loaded 2s, check if fill out"), m() || (C("Window is not fill out, continue fetch message"), u()), k = null
                }, 2e3), n(function () {
                    C("Loading message ok"), t.hideToast(), t.isMessageReady = !0
                })
            })), S = n(function () {
                C("After message loaded 2s, mark readtime"), t.doMarkReadTime(), S = null
            }, 2e3), n(f))
        }

        function l() {
            M = n(function () {
                t.isAutoScroll && t.listCurrent.length > 40 && (C("Clean chat history to clean memory"), t.listCurrent = t.listCurrent.slice(-30), h()), l()
            }, 2e3)
        }

        function u(n) {
            return n = e.extend({from: t.latest && t.latest.id}, b, n || {}), C("Start load messages", n), t.httpMessage = s.query(n), t.httpMessage.$promise.then(function (e) {
                return C("Finish load messages: " + e.length), e.forEach(g), h(), e
            })
        }

        function d(t, n, i) {
            e.element("#" + t)[0] && (n = n || 250, i = i || 0, C("Scroll to element", t, i, n), e.element("#chat-container").scrollTo(e.element("#" + t), i, n))
        }

        function f() {
            d("bottom")
        }

        function p(e) {
            e.id && ((!t.latest || e.created > t.latest.created) && (t.latest = e), (!t.oldest || e.created < t.oldest.created) && (t.oldest = e))
        }

        function h() {
            t.listCurrent.sort(function (e, t) {
                return e.created - t.created
            }), t.oldest = t.listCurrent[0], t.latest = t.listCurrent[t.listCurrent.length - 1]
        }

        function m() {
            var e = $("#chat-container");
            return e[0].scrollHeight > e.innerHeight()
        }

        function g(n, i) {
            var o = n.channelId;
            if (o === y) {
                var r = t.channels[o];
                if (r && t.listMessages[o]) {
                    var a = -1;
                    return p(n), n.id && (!t.isMessageReady || !t.isWindowActived) && r.uMeta && n.created > r.uMeta.readTime && n.creatorId !== t.idLogin && !t.currentChannel.uHasUnread && (t.currentChannel.uNewPos = n.id), n.id && e.forEach(t.listCurrent, function (i, o) {
                        (i.id === n.id || i.meta && n.meta && i.meta.clientId && i.meta.clientId === n.meta.clientId) && (t.listCurrent[o] = e.extend(t.listCurrent[o], n), a = o)
                    }), -1 === a && (i && n.creatorId !== t.idLogin && (n.$isNew = !0), a = t.listCurrent.push(n) - 1), t.listCurrent[a]
                }
            }
        }

        function v(n, i) {
            i = i || i;
            var o = -1;
            return e.forEach(t.listMessages[i], function (e, t) {
                e.id === n && (o = t)
            }), -1 !== o ? t.listMessages[i][o] : !1
        }

        function w(e) {
            for (var n = e.channelId, i = 0; i < t.listMessages[n].length; ++i)if (t.listMessages[n][i] == e)return t.listMessages[n].splice(i--, 1);
            return!1
        }

        var y, b, C = window.debug("app:chat"), k = null, S = null;
        t.isAutoScroll = !0, t.isMessageReady = !1, t.isNewMessageUp = !1, t.isNewMessageDown = !1, t.isNewInView = !1, t.isLoadFinished = !1, t.inputNamesString = "", t.posProfile = !1, t.isLoadOldMessage = !1, t.idLoadOldMessage = null, t.idIndicateLast = null, t.idIndicator = null, t.indicator = null, t.listCurrent = null, t.oldest = null, t.latest = null, t.httpMessage = null, t.addMessage = g, t.removeMessage = w, t.getMessage = v, t.resortList = h, t.goBottom = f, t.goPos = d, c(), t.$on("channel.changed", c), t.markReadMessage = function () {
            n(function () {
                t.doMarkReadTime()
            }, 1e3)
        }, t.$on("app.active", function () {
            !t.currentChannel.uHasUnread || t.isNewMessageDown || t.isNewMessageUp || (C("Has unread, mark readtime again"), t.markReadMessage())
        }), t.$on("message.received", function (e, n, i) {
            "child.delete" === n || i.value.channelId !== y || t.idIndicator || (g(s["new"](i.value), !0), h())
        }), t.$on("chat.indicate", function (e, i) {
            C("Start indicate message", i), t.idIndicator = i;
            var o = v(i);
            return o ? void t.goPos("m" + i, 250, 200) : (t.listCurrent = [], void u({indicator: i, from: null}).then(function (e) {
                e && e.length && (e.forEach(function (n, o) {
                    n.id === i && (t.indicator = e[o])
                }), t.idIndicateLast = e[e.length - 1].id, n(function () {
                    t.goPos("m" + i, 250, 200)
                }))
            }))
        }), t.$on("timeline.scroll", function (e, n) {
            1 === n ? t.isAutoScroll || (t.isAutoScroll = !0, C("Auto scroll enabled"), t.isWindowActived && t.doMarkReadTime()) : (t.isAutoScroll && (C("Auto scroll disabled"), t.isAutoScroll = !1), 0 !== n || t.isLoadFinished || (C("Loading history"), t.isLoadOldMessage = !0, u({reverse: 1, from: t.oldest && t.oldest.id}).then(function (e) {
                t.isLoadOldMessage = !1, t.idLoadOldMessage = e && e[0] ? e[0].id : "", t.isLoadFinished = !e.length
            })))
        });
        var M;
        t.setNewMessageVisible = function (e, n) {
            t.isNewMessageDown = e, t.isNewMessageUp = n
        }, t.isShowAuthor = function (e) {
            var n = t.listCurrent[e - 1], i = t.listCurrent[e];
            return t.isShowNewThread(e) || "system" === n.type || (i.creatorId ? n.creatorId !== i.creatorId : i.robotId && n.robotId !== i.robotId)
        }, t.isShowNewThread = function (e) {
            var n = t.listCurrent[e - 1], i = t.listCurrent[e];
            return!n || (i.id ? i.created - n.created > 6e4 : Date.now() - n.created > 6e4)
        }, t.isShowCommentHeader = function (e) {
            var n = t.listCurrent[e - 1], i = t.listCurrent[e];
            return!(n && "comment" === n.type && "comment" === i.type && n.comment.oid == i.comment.oid)
        }, t.doRestoreChat = function () {
            t.listCurrent = t.listMessages[y], t.idIndicator = null, t.indicator = null, t.idIndicateLast = null, t.isLoadFinished = !1, h(), n(function () {
                t.goPos("bottom")
            })
        }, t.getFileList = function () {
            return t.listCurrent.filter(function (e) {
                return"file" === e.type && e.file
            }).sort(function (e, t) {
                return t.created - e.created
            }).map(function (e) {
                return e.file
            }).reverse()
        }, t.doDeleteMessage = function (e) {
            e && !e.$isProcessing && (e.$isProcessing = !0, confirm("确认删除消息？") && s["delete"]({id: e.id}, function () {
                w(e), C("Success delete message: " + e.id)
            }, t.handleResourceError).$promise["finally"](function () {
                delete e.$isProcessing
            }))
        };
        var A = !1;
        t.doMarkReadTime = function () {
            A || (A = !0, t.doSetChannelMeta(y, "readTime").then(function (e) {
                e && (t.channels[y].uHasUnread = !1, t.channels[y].uUnreadCount = 0, A = !1)
            }, function () {
                A = !1
            }))
        }
    }]).controller("AppSendboxCtrl", ["$scope", "$timeout", "Upload", "Util", "$routeSegment", "Message", "Task", "File", "Qiniu", "KEY", "UUID", function (n, i, o, r, a, s, c, l, u, d, f) {
        function p() {
            n.idChannel && (t("Active AppSendboxCtrl"), I && x.clear(), I = n.idChannel, n.isDisabled = "person" === n.currentChannel.type, A(!0), n.$pubu ? S() : n.$on("pubu.connect", S))
        }

        function h() {
            t("Focus sendbox"), n.focusOn("sendbox")
        }

        function m() {
            n.isActived = !1
        }

        function g(e) {
            n.listAutoCompleteItems = Object.keys(n.commands[I]).filter(function (t) {
                return"$" !== t[0] && (!e || 0 === t.indexOf(e))
            }).map(function (e) {
                return n.commands[I][e]
            })
        }

        function v(e) {
            return n.listAutoCompleteItems = M(e).filter(function (e) {
                for (var t = 0; t < n.mentions.length; t++) {
                    if ("channel" === n.newMessage.broadcast && "ALL" === e.id)return!1;
                    if (n.currentUser.id === e.id)return!1;
                    var i = -1 !== n.currentChannel.usersIds.indexOf(e.id);
                    if (!i)return!1;
                    if (n.mentions[t] && n.mentions[t].id === e.id)return!1
                }
                return!0
            }), !!n.listAutoCompleteItems.length
        }

        function $(e) {
            var t = e.match(/^(?:\/|、)(\S+)?/), i = t[1];
            return b(), n.commands[I][i] ? void(n.newMessage.$isCommand = !0) : (n.indexSelected = 0, void(n.isDisabled || g(i)))
        }

        function w(e) {
            if (n.isDisabled)return void b();
            var t = e.match(/@(\S+)?/g);
            if (n.mentions = [], n.indexMention = !1, n.indexSelected = 0, t) {
                var i = !1, o = !1;
                t.forEach(function (e, t) {
                    var r = e.slice(1);
                    n.mentions[t] = y(r), o || n.mentions[t] || (o = r, i = t)
                }), o !== !1 && v(o) ? n.indexMention = i : k()
            } else k();
            b()
        }

        function y(e) {
            var t = M(e);
            for (var n in t)if (t[n].name === e)return t[n];
            return!1
        }

        function b() {
            var e = 0;
            n.newMessage.text = r.escapeHtml(n.newMessage._text).replace(/@(\S+)?/g, function (t, i) {
                var o = n.mentions[e];
                return e++, o && o.name === i && o.id ? "@[" + o.name + "](user:" + o.id + ")" : t
            }), t("Update input message", n.newMessage.text)
        }

        function C(e) {
            var t = n.listAutoCompleteItems[e];
            if (n.newMessage.$isCommand)n.newMessage._text = n.newMessage._text.replace(/^(?:\/|、)(\S+)?/, function () {
                return"/" + t.name + " "
            }), n.newMessage.text = r.escapeHtml(n.newMessage._text), n.newMessage.$isCommand = !0; else if (e === n.listAutoCompleteItems.length && (t = {id: "ALL", name: n.$config.locales["LABEL.MENTION_ALL"]}), t && n.indexMention !== !1) {
                var i = -1;
                n.mentions[n.indexMention] = t, n.isAutoReplace = !0, n.newMessage._text = n.newMessage._text.replace(/@(\S+)?/g, function (e) {
                    return i++, n.indexMention === i ? "@" + n.mentions[i].name + " " : e
                }), n.isAutoReplace = !1, b()
            }
            k()
        }

        function k() {
            n.listAutoCompleteItems = [], n.indexSelected = 0, n.isActived = !0, n.indexMention = !1
        }

        function S() {
            function e() {
                n.inputNamesString = r.length ? r.join("，") + " 正在输入..." : "", n.$apply()
            }

            function i(t) {
                o[t] && clearTimeout(o[t]), o[t] = setTimeout(function () {
                    var i = r.indexOf(t);
                    -1 !== i && r.splice(i, 1), e(), n.$apply()
                }, 2e3)
            }

            x = n.$pubu.child("T" + n.idTeam + "/C" + I + "/inputstatuses");
            var o = {}, r = [];
            x.on(["child.create", "child.update"], function (o) {
                var a = o.value;
                t("Input status received", a), a !== n.currentUser.name && (-1 === r.indexOf(a) && r.push(a), e(), i(a))
            })
        }

        function M(t) {
            var i = e.copy(n.listUsers);
            return t && (i = i.filter(function (e) {
                return e.name && (e.name.toLowerCase().indexOf(t.toLowerCase()) > -1 || e.namePinyin && e.namePinyin.indexOf(t.toLowerCase()) > -1 || e.nameFirstLetter && e.nameFirstLetter.indexOf(t.toLowerCase()) > -1)
            })), i
        }

        function A(e) {
            n.newMessage = e && n.newMessages[I] ? n.newMessages[I] : n.newMessages[I] = {type: "text", text: "", _text: "", meta: {clientId: f["new"]()}, broadcast: "", channel: I, channelId: I, created: Date.now() + 6e5, creator: n.idLogin, creatorId: n.idLogin}
        }

        var I, x;
        n.listAutoCompleteItems = [], n.indexSelected = 0, n.mentions = {}, n.indexMention = !1, n.isAutoReplace = !1, n.isActived = !0, n.isForceShow = !1, n.selectItem = C, A(), p(), n.$on("channel.changed", p), n.isShowThumbsUpSendButton = function () {
            return!n.newMessage._text && n.latest && n.latest.creatorId !== n.idLogin
        }, n.$on("start.sendbox", h), n.$on("start.command", function (e, t) {
            n.newMessage._text = "/" + t + " ", i(h)
        }), n.$watch("newMessage._text", function (e) {
            void 0 === e || n.isAutoReplace || ("/" !== e[0] && "、" !== e[0] ? (n.newMessage.broadcast = new RegExp("@" + n.$config.locales["LABEL.MENTION_ALL"]).test(e) ? "channel" : "", n.newMessage.$isCommand = !1, w(e)) : (n.newMessage.$isCommand = !0, $(e)))
        });
        var U;
        n.$watch("newMessage._text", function (e) {
            e && !U && (x.set(n.idLogin, n.currentUser.name), U = i(function () {
                U = null
            }, 500))
        }), n.addInput = function (e) {
            n.newMessage._text += e
        }, n.handleInput = function (e) {
            if (!e.shiftKey && !e.ctrlKey) {
                var t = !1;
                switch (e.keyCode) {
                    case d.UP:
                        n.listAutoCompleteItems.length && (t = !0, n.indexSelected = n.indexSelected > 0 ? n.indexSelected - 1 : n.listAutoCompleteItems.length);
                        break;
                    case d.DOWN:
                        n.listAutoCompleteItems.length && (t = !0, n.indexSelected = n.indexSelected == n.listAutoCompleteItems.length ? 0 : n.indexSelected + 1);
                        break;
                    case d.RETURN:
                        n.listAutoCompleteItems.length || (t = !0, n.doSendMessage(), k());
                    case d.TAB:
                        n.listAutoCompleteItems.length && (t = !0, C(n.indexSelected));
                        break;
                    case d.ESC:
                        t = !0, n.listAutoCompleteItems.length ? k() : m()
                }
                t && (e.preventDefault(), e.stopPropagation())
            }
        }, n.$shared.doSendMessage = n.doSendMessage = function (o) {
            var r = n.listCurrent[n.listCurrent.length - 1];
            if (!r || r.id || !r.$state || "fail" === r.$state) {
                n.currentChannel.uNewPos = null, n.currentChannel.uHasUnread = !1, n.currentChannel.uUnreadCount = 0;
                var a, c;
                if (c = o ? e.extend({created: Date.now()}, n.newMessage, o) : e.extend({created: Date.now()}, n.newMessage), ("text" !== c.type || c.text) && ("file" !== c.type || c.file && e.isString(c.file.path))) {
                    if (t("Sending message"), a = s.save(c), n.$broadcast("message.send"), !c.$isCommand)var l = n.addMessage(s["new"](e.extend({$state: "sending", $isNew: !0}, c)));
                    "person" !== n.currentChannel.type || n.users[n.currentChannel.toId].online || n.addMessage(s["new"]({type: "system", text: n.$config.locales["MESSAGE.SEND_USER_OFFLINE"], created: Date.now() + 1500, creator: n.idLogin, channelId: I})), i(function () {
                        n.isAutoScroll = !0, n.goBottom()
                    }), A(), a.$promise.then(function (i) {
                        t("完成发布，消除消息发布状态"), i.$state = null, l ? l = e.extend(l, i) : n.addMessage(i)
                    }, function (e) {
                        n.handleResourceError(e), l && (l.$state = "fail")
                    })
                }
            }
        }, n.handlePaste = function (e) {
            var i;
            if (window.macgap) {
                var r = window.macgap.clipboard.pasteImage();
                if (!r)return;
                for (var a = window.atob(r), s = new Uint8Array(a.length), c = 0; c < a.length; c++)s[c] = a.charCodeAt(c);
                i = new Blob([s], {type: "image/png", encoding: "utf-8"})
            } else {
                if (!e.clipboardData && e.originalEvent && (e.clipboardData = e.originalEvent.clipboardData), !e.clipboardData)return;
                for (var c = 0; c < e.clipboardData.items.length; c++) {
                    var d = e.clipboardData.items[c];
                    if (-1 !== d.type.indexOf("image")) {
                        i = d.getAsFile();
                        break
                    }
                }
            }
            if (i) {
                e.preventDefault(), n.newMessage.type = "file", n.newMessage.file = l["new"]({name: n.$config.locales["LABEL.PREFIX_CLIPBOARD"] + moment().format("YY-MM-DD HH:mm_") + Math.floor(1e3 * Math.random()) + ".png", path: i, size: i.size, type: i.type, category: "image"});
                try {
                    n.upload = o(i, u.keygen("files") + "/" + n.newMessage.file.name.replace(/\s/g, "_"), {absolute: !0, limit: 31457280}).success(function (e) {
                        t("上传成功", e), n.newMessage.file.path = e.key
                    }).error(function (e) {
                        n.newMessage.$state = "fail", e && n.handleUploadError(e)
                    })
                } catch (f) {
                    n.newMessage.$state = "fail", f && n.handleUploadError(f)
                }
            }
        }, n.$shared.onFileSelect = n.onFileSelect = function (r) {
            for (var a = 0; a < r.length; a++) {
                var c = r[a];
                c.size > 31457280 || !function () {
                    var r = e.extend(n.newMessage, {type: "file", file: l["new"]({name: c.name, path: c, size: c.size, type: c.type})}), a = n.addMessage(e.extend({$state: "sending"}, r));
                    A(), i(function () {
                        n.isAutoScroll = !0, n.goBottom()
                    });
                    try {
                        n.upload = o(c, u.keygen("files") + "/" + c.name.replace(/\s/g, "_"), {absolute: !0, limit: 31457280}).success(function (n) {
                            t("上传成功", n);
                            var i = e.copy(a);
                            i.file.path = n.key, s.save(i, function (t) {
                                t.$state = null, a = e.extend(a, s["new"](t))
                            }, function () {
                                t("错误发布"), a.$state = "fail"
                            })
                        }).error(function (e) {
                            a.$state = "fail", e && n.handleUploadError(e)
                        })
                    } catch (d) {
                        a.$state = "fail", d && n.handleUploadError(d)
                    }
                }()
            }
        }
    }])
}(angular);